<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - Ellacy CRM</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="fixed left-0 top-0 h-screen w-64 bg-white shadow-lg">
            <div class="p-6">
                <div class="flex items-center mb-2">
                    <img src="../../ApplyLead_logo.png" alt="ApplyLead" class="h-9">
                </div>
                <div class="flex items-center">
                    <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Admin</span>
                </div>
            </div>
            <nav class="mt">
                <a href="CRM-dashboard.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="CRM-applications.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Applications
                </a>
                <a href="CRM-agent.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Agents
                </a>
                <a href="CRM-scholarships.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="graduation-cap" class="w-5 h-5 mr-3"></i>
                    Scholarships
                </a>
                <a href="CRM-institutions.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="building" class="w-5 h-5 mr-3"></i>
                    Institutions
                </a>
                <a href="CRM-students.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                    Students
                </a>
                <a href="CRM-payment.html" class="flex items-center px-6 py-3 text-white"
                    style="background-color: #d82128;">
                    <i data-lucide="credit-card" class="w-5 h-5 mr-3"></i>
                    Payments
                </a>
                <a href="CRM-tasks.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-3"></i>
                    Tasks
                </a>
                <a href="CRM-Campaigns.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="brick-wall-shield" class="w-5 h-5 mr-3"></i>
                    Campaigns
                </a>
                <a href="CRM-report.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="bar-chart" class="w-5 h-5 mr-3"></i>
                    Reports
                </a>
                <a href="CRM-messages.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                    Messages
                </a>
                <a href="CRM-user-admin.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="shield" class="w-5 h-5 mr-3"></i>
                    User Admin
                </a>

                <a href="CRM-Setting.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i>
                    Settings
                </a>
            </nav>
            <div class="mt-auto px-6 py-4 border-t border-gray-200">
                <p class="text-sm text-gray-600 text-center">Designed & developed by Innotech Viet Nam</p>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="ml-64 flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6">
                <h2 class="text-xl font-semibold text-gray-800">Payments / Disbursement</h2>
                <div class="flex items-center space-x-4">
                    <button class="p-2 hover:bg-gray-100 rounded-full">
                        <div class="relative">
                            <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
                            <span
                                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">3</span>
                        </div>
                    </button>
                    <div class="relative" id="profile-menu">
                        <button class="flex items-center">
                            <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80"
                                alt="Admin profile" class="w-8 h-8 rounded-full object-cover">
                        </button>
                        <div id="profile-dropdown"
                            class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-1">
                            <a href="CRM-Setting.html"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                onclick="handleLogout()">Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Tabs Navigation -->
                <div class="bg-white rounded-lg shadow-sm mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex gap-4 px-6">
                            <button onclick="switchPaymentTab('overview')" id="tab-btn-overview"
                                class="payment-tab-button border-b-2 py-3 px-2 text-sm font-medium"
                                style="border-color:#d82128;color:#d82128;">Payments Overview</button>
                            <button onclick="switchPaymentTab('config')" id="tab-btn-config"
                                class="payment-tab-button border-b-2 border-transparent py-3 px-2 text-sm font-medium text-gray-500 hover:text-gray-700">Payment
                                Config</button>
                            <button onclick="switchPaymentTab('commission')" id="tab-btn-commission"
                                class="payment-tab-button border-b-2 border-transparent py-3 px-2 text-sm font-medium text-gray-500 hover:text-gray-700 flex items-center gap-2">
                                Agent Commission
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Tab Content: Payments Overview -->
                <div id="tab-overview" class="payment-tab-content">

                    <!-- Header with Create Invoice Button -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Payments & Invoices Overview</h2>
                            <p class="text-sm text-gray-600 mt-1">Manage student invoices, commissions, and scholarship
                                disbursements</p>
                        </div>
                        <button onclick="openCreateInvoiceModal()" type="button"
                            class="px-5 py-2.5 mr-6 rounded-lg text-white font-semibold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all"
                            style="background: linear-gradient(135deg, #d82128 0%, #a01820 100%);">
                            <i data-lucide="file-plus" class="w-5 h-5"></i>
                            Create Invoice
                        </button>
                    </div>
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-6">
                        <!-- This Month's Payouts -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-gray-600">This Month's Payouts</h3>
                                <i data-lucide="dollar-sign" class="w-5 h-5 text-red-500"></i>
                            </div>
                            <div class="flex items-baseline">
                                <span class="text-2xl font-bold text-gray-900">$58,500</span>
                            </div>
                        </div>

                        <!-- Pending Review Invoices -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">Invoices Pending Review</h3>
                                    <p class="text-xs text-gray-400 mt-1">Awaiting approval</p>
                                </div>
                                <i data-lucide="clock" class="w-5 h-5 text-red-500"></i>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-baseline">
                                    <span class="text-2xl font-bold text-gray-900">$12,500</span>
                                    <span class="ml-2 text-sm text-gray-500">Total Amount</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i data-lucide="file-text" class="w-4 h-4 text-gray-400 mr-1"></i>
                                    <span class="text-gray-600"><strong>2</strong> invoices pending</span>
                                </div>
                            </div>
                        </div>

                        <!-- Unpaid Invoices -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600">Unpaid Invoices</h3>
                                    <p class="text-xs text-gray-400 mt-1">Outstanding payments</p>
                                </div>
                                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-baseline">
                                    <span class="text-2xl font-bold text-gray-900">$32,500</span>
                                    <span class="ml-2 text-sm text-gray-500">Total Amount</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i data-lucide="file-text" class="w-4 h-4 text-gray-400 mr-1"></i>
                                    <span class="text-gray-600"><strong>5</strong> invoices unpaid</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter & Search Bar -->
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="p-6">
                            <div class="flex flex-wrap items-end gap-4">
                                <!-- Search Bar -->
                                <div class="w-full sm:w-64">
                                    <div class="relative">
                                        <input type="text" id="search"
                                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm pl-10"
                                            placeholder="Search by name, email">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Date Range -->
                                <div class="w-full sm:w-auto">
                                    <label for="date-range" class="block text-sm font-medium text-gray-700 mb-1">Date
                                        Range</label>
                                    <select id="date-range"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                                        <option value="this-month">This Month</option>
                                        <option value="last-month">Last Month</option>
                                        <option value="last-3-months">Last 3 Months</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>

                                <!-- Status Filter -->
                                <div class="w-full sm:w-auto">
                                    <label for="status-filter"
                                        class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="status-filter"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                                        <option value="all" selected>All</option>
                                        <option value="paid">Paid</option>
                                        <option value="unpaid">Unpaid</option>
                                    </select>
                                </div>

                                <!-- Export Button -->
                                <div class="w-full sm:w-auto flex items-end ml-auto">
                                    <button type="button"
                                        class="w-full sm:w-auto inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                        style="background: linear-gradient(135deg, #d82128 0%, #a01820 100%);">
                                        <i data-lucide="download" class="h-5 w-5"></i>
                                        Export Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payments Table -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <!-- Table Container with Horizontal Scroll -->
                        <div class="overflow-x-auto">
                            <!-- Table Container with Fixed Height and Vertical Scroll -->
                            <div class="max-h-[calc(100vh-24rem)] overflow-y-auto">
                                <div class="min-w-full align-middle inline-block">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead>
                                            <tr>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Recipient</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Program</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Universities</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Payment Stage</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Amount</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Commission</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Due Date</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Status</th>
                                                <th scope="col"
                                                    class="pr-6 pl-10 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                    Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <!-- Sample Row 1 -->
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <div class="flex-shrink-0 h-10 w-10">
                                                            <img class="h-10 w-10 rounded-full"
                                                                src="https://ui-avatars.com/api/?name=John+Smith"
                                                                alt="">
                                                        </div>
                                                        <div class="ml-4">
                                                            <div class="text-sm font-semibold text-gray-900">John Smith
                                                            </div>
                                                            <div class="text-xs text-gray-500">john@example.com</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td
                                                    class="px-6 py-4 text-sm text-gray-900 whitespace-normal break-words">
                                                    EF
                                                    Scholarship Guarantee (3–5 Universities)</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex flex-col space-y-1 text-sm text-gray-900">
                                                        <span>Angelo State University</span>
                                                        <span>ButlerUniversity</span>
                                                        <span>Ohio Northern University</span>
                                                        <span>Schiller International University</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Third
                                                    Payment</td>
                                                <td
                                                    class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                                                    $6,500.00</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$1,000.00
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Nov 27,
                                                    2025</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span
                                                        class="status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending
                                                        Review</span>
                                                </td>
                                                <td
                                                    class="pr-6 pl-10 py-4 whitespace-nowrap text-left text-sm font-medium">
                                                    <button onclick="openPaymentDetails()"
                                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-gray-800 hover:bg-gray-50 rounded-md text-sm font-medium mr-2">
                                                        <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
                                                        View
                                                    </button>
                                                    <button onclick="markAsPaid(this)"
                                                        class="inline-flex items-center px-3 py-1.5 border border-red-600 text-red-700 hover:bg-red-50 rounded-md text-sm font-medium">
                                                        <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                                        Mark as Paid
                                                    </button>
                                                </td>
                                            </tr>

                                            <!-- Sample Row 2 -->
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <div class="flex-shrink-0 h-10 w-10">
                                                            <img class="h-10 w-10 rounded-full"
                                                                src="https://ui-avatars.com/api/?name=Sarah+Johnson"
                                                                alt="">
                                                        </div>
                                                        <div class="ml-4">
                                                            <div class="text-sm font-semibold text-gray-900">Sarah
                                                                Johnson</div>
                                                            <div class="text-xs text-gray-500">sarah@university.edu
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td
                                                    class="px-6 py-4 text-sm text-gray-900 whitespace-normal break-words">
                                                    Elite
                                                    Admission Program</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex flex-col space-y-1 text-sm text-gray-900">
                                                        <span>Princeton University</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">First
                                                    Payment</td>
                                                <td
                                                    class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                                                    $2,000.00</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Dec 05,
                                                    2025</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span
                                                        class="status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Unpaid</span>
                                                </td>
                                                <td
                                                    class="pr-6 pl-10 py-4 whitespace-nowrap text-left text-sm font-medium">
                                                    <button onclick="openPaymentDetails()"
                                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-gray-800 hover:bg-gray-50 rounded-md text-sm font-medium">
                                                        <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
                                                        View
                                                    </button>
                                                    <button onclick="markAsPaid(this)"
                                                        class="inline-flex items-center px-3 py-1.5 border border-red-600 text-red-700 hover:bg-red-50 rounded-md text-sm font-medium ml-2">
                                                        <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                                        Mark as Paid
                                                    </button>
                                                </td>
                                            </tr>

                                            <!-- Sample Row 3 -->
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <div class="flex-shrink-0 h-10 w-10">
                                                            <img class="h-10 w-10 rounded-full"
                                                                src="https://ui-avatars.com/api/?name=Michael+Nguyen"
                                                                alt="">
                                                        </div>
                                                        <div class="ml-4">
                                                            <div class="text-sm font-semibold text-gray-900">Michael
                                                                Nguyen</div>
                                                            <div class="text-xs text-gray-500">
                                                                michael.nguyen@example.com</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td
                                                    class="px-6 py-4 text-sm text-gray-900 whitespace-normal break-words">
                                                    Ivy Global Standard</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex flex-col space-y-1 text-sm text-gray-900">
                                                        <span>Columbia University</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Second
                                                    Payment</td>
                                                <td
                                                    class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                                                    $8,200.00</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Jan 15,
                                                    2026</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span
                                                        class="status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Paid</span>
                                                </td>
                                                <td
                                                    class="pr-6 pl-10 py-4 whitespace-nowrap text-left text-sm font-medium">
                                                    <button onclick="openPaymentDetails()"
                                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-gray-800 hover:bg-gray-50 rounded-md text-sm font-medium mr-2">
                                                        <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
                                                        View
                                                    </button>
                                                    <button disabled
                                                        class="inline-flex items-center px-3 py-1.5 border border-gray-200 text-gray-400 cursor-not-allowed rounded-md text-sm font-medium">
                                                        <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                                        Paid
                                                    </button>
                                                </td>
                                            </tr>

                                            <!-- Sample Row 4 -->
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <div class="flex-shrink-0 h-10 w-10">
                                                            <img class="h-10 w-10 rounded-full"
                                                                src="https://ui-avatars.com/api/?name=Emily+Tran"
                                                                alt="">
                                                        </div>
                                                        <div class="ml-4">
                                                            <div class="text-sm font-semibold text-gray-900">Emily Tran
                                                            </div>
                                                            <div class="text-xs text-gray-500">emily.tran@example.com
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td
                                                    class="px-6 py-4 text-sm text-gray-900 whitespace-normal break-words">
                                                    EF Scholarship Guarantee (1 University)</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex flex-col space-y-1 text-sm text-gray-900">
                                                        <span>Boston University</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">First
                                                    Payment
                                                </td>
                                                <td
                                                    class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                                                    $1,200.00</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Dec 20,
                                                    2025</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span
                                                        class="status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Unpaid</span>
                                                </td>
                                                <td
                                                    class="pr-6 pl-10 py-4 whitespace-nowrap text-left text-sm font-medium">
                                                    <button onclick="openPaymentDetails()"
                                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-gray-800 hover:bg-gray-50 rounded-md text-sm font-medium">
                                                        <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
                                                        View
                                                    </button>
                                                    <button onclick="markAsPaid(this)"
                                                        class="inline-flex items-center px-3 py-1.5 border border-red-600 text-red-700 hover:bg-red-50 rounded-md text-sm font-medium ml-2">
                                                        <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                                        Mark as Paid
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination (tab-only) -->
                        <div class="bg-white sticky bottom-0 px-4 py-3 border-t border-gray-200 sm:px-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-end gap-3">
                                <!-- Rows per page -->
                                <div class="flex items-center gap-2">
                                    <label for="overview_rows_per_page" class="text-sm text-gray-600">Rows per
                                        page</label>
                                    <select id="overview_rows_per_page"
                                        class="rounded-md border-gray-300 text-sm focus:ring-red-500 focus:border-red-500">
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>

                                <!-- Numeric pagination -->
                                <div class="flex items-center justify-center gap-1">
                                    <button id="overview_prev"
                                        class="inline-flex items-center px-2 py-1.5 text-sm border rounded-md text-gray-700 hover:bg-gray-50">
                                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                    </button>
                                    <div id="overview_pages" class="flex items-center gap-1"></div>
                                    <button id="overview_next"
                                        class="inline-flex items-center px-2 py-1.5 text-sm border rounded-md text-gray-700 hover:bg-gray-50">
                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <!-- Info -->
                                <div id="overview_page_info" class="text-sm text-gray-600 text-center sm:text-right">
                                    Page 1 of 5</div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Modal -->
                    <div id="payment-details-modal"
                        class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 overflow-y-auto z-50">
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
                                <!-- Modal Header -->
                                <div class="flex items-center justify-between p-6 border-b">
                                    <div>
                                        <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                                            <i data-lucide="credit-card" class="w-5 h-5 text-red-500"></i>
                                            Payment Details
                                        </h3>
                                        <p class="text-sm text-gray-500 mt-1">Overview of selected payout aligned with
                                            table columns</p>
                                    </div>
                                    <button onclick="closePaymentDetails()" class="text-gray-400 hover:text-gray-500">
                                        <i data-lucide="x" class="h-6 w-6"></i>
                                    </button>
                                </div>

                                <!-- Modal Content: redesigned to mirror table columns -->
                                <div class="p-6">
                                    <!-- Top: Recipient -->
                                    <div class="flex items-center mb-6">
                                        <img class="h-12 w-12 rounded-full"
                                            src="https://ui-avatars.com/api/?name=John+Smith" alt="">
                                        <div class="ml-4">
                                            <p class="text-base font-semibold text-gray-900">John Smith</p>
                                            <p class="text-sm text-gray-500">john@example.com</p>
                                        </div>
                                    </div>

                                    <!-- Details Grid matching table columns -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Program -->
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <p class="text-xs text-gray-500 mb-1">Program</p>
                                            <p class="text-sm font-medium text-gray-900">EF Scholarship Guarantee (3–5
                                                Universities)</p>
                                        </div>

                                        <!-- Payment Stage -->
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <p class="text-xs text-gray-500 mb-1">Payment Stage</p>
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Third
                                                    Payment</span>
                                            </div>
                                        </div>

                                        <!-- Universities -->
                                        <div class="bg-gray-50 rounded-lg p-4 md:col-span-2">
                                            <p class="text-xs text-gray-500 mb-2">Universities</p>
                                            <div class="flex flex-wrap gap-2 text-sm">
                                                <span
                                                    class="px-2.5 py-1 rounded-full bg-white border text-gray-800">Angelo
                                                    State University</span>
                                                <span
                                                    class="px-2.5 py-1 rounded-full bg-white border text-gray-800">ButlerUniversity</span>
                                                <span
                                                    class="px-2.5 py-1 rounded-full bg-white border text-gray-800">Ohio
                                                    Northern University</span>
                                                <span
                                                    class="px-2.5 py-1 rounded-full bg-white border text-gray-800">Schiller
                                                    International University</span>
                                            </div>
                                        </div>

                                        <!-- Amount / Commission / Due Date in one row -->
                                        <div class="md:col-span-2">
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <!-- Amount -->
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <p class="text-xs text-gray-500 mb-1">Amount</p>
                                                    <p class="text-lg font-semibold text-gray-900">$6,500.00</p>
                                                </div>

                                                <!-- Commission -->
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <p class="text-xs text-gray-500 mb-1">Commission</p>
                                                    <p class="text-lg font-semibold text-gray-900">$1,000.00</p>
                                                </div>

                                                <!-- Due Date -->
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <p class="text-xs text-gray-500 mb-1">Due Date</p>
                                                    <p class="text-sm font-medium text-gray-900">Nov 27, 2025</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Linked Application (optional info) -->
                                    <div class="mt-6">
                                        <h4 class="text-sm font-medium text-gray-600 mb-3">Linked Application</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="text-sm font-medium text-gray-900">APP-2025-001</p>
                                                    <p class="text-sm text-gray-500">MBA Program at Harvard Business
                                                        School</p>
                                                </div>
                                                <a href="CRM-application-details.html" target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="inline-flex items-center text-sm font-medium text-red-500 hover:text-red-700">
                                                    <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                                                    View Application
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Evidence uploaded by student -->
                                    <div class="mt-6">
                                        <h4 class="text-sm font-medium text-gray-600 mb-3 flex items-center gap-2">
                                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                                            Evidence Uploaded by Student
                                        </h4>
                                        <div class="bg-gray-50 border rounded-lg p-4">
                                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                                <!-- Evidence Card 1: Image -->
                                                <div class="rounded-lg bg-white border overflow-hidden">
                                                    <div
                                                        class="aspect-video bg-gray-100 flex items-center justify-center overflow-hidden">
                                                        <img src="https://images.unsplash.com/photo-1554224155-1696413565d3?q=80&w=800&auto=format&fit=crop"
                                                            alt="Invoice Screenshot" class="w-full h-full object-cover">
                                                    </div>
                                                    <div class="p-3">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <p class="text-sm font-medium text-gray-900">
                                                                    invoice_screenshot.jpg</p>
                                                                <p class="text-xs text-gray-500">1.2 MB • Uploaded Nov
                                                                    26, 2025</p>
                                                            </div>
                                                            <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                                                        </div>
                                                        <div class="mt-3 flex items-center gap-2">
                                                            <button type="button"
                                                                onclick="openEvidenceViewer('https://images.unsplash.com/photo-1554224155-1696413565d3?q=80&w=1600&auto=format&fit=crop')"
                                                                class="inline-flex items-center px-3 py-1.5 text-xs border rounded-md hover:bg-gray-50">
                                                                <i data-lucide="eye" class="w-3.5 h-3.5 mr-1"></i>
                                                                View
                                                            </button>
                                                            <a href="https://images.unsplash.com/photo-1554224155-1696413565d3?q=80&w=1600&auto=format&fit=crop"
                                                                download target="_blank" rel="noopener noreferrer"
                                                                class="inline-flex items-center px-3 py-1.5 text-xs border rounded-md hover:bg-gray-50">
                                                                <i data-lucide="download" class="w-3.5 h-3.5 mr-1"></i>
                                                                Download
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Evidence Card 2: PDF -->
                                                <div class="rounded-lg bg-white border overflow-hidden">
                                                    <div
                                                        class="aspect-video bg-gray-100 flex items-center justify-center">
                                                        <i data-lucide="file-text" class="w-10 h-10 text-gray-400"></i>
                                                    </div>
                                                    <div class="p-3">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <p class="text-sm font-medium text-gray-900">
                                                                    bank_receipt.pdf</p>
                                                                <p class="text-xs text-gray-500">450 KB • Uploaded Nov
                                                                    26, 2025</p>
                                                            </div>
                                                            <i data-lucide="file" class="w-4 h-4 text-gray-400"></i>
                                                        </div>
                                                        <div class="mt-3 flex items-center gap-2">
                                                            <button type="button"
                                                                onclick="openEvidenceViewer('https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf')"
                                                                class="inline-flex items-center px-3 py-1.5 text-xs border rounded-md hover:bg-gray-50">
                                                                <i data-lucide="eye" class="w-3.5 h-3.5 mr-1"></i>
                                                                View
                                                            </button>
                                                            <a href="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf"
                                                                download target="_blank" rel="noopener noreferrer"
                                                                class="inline-flex items-center px-3 py-1.5 text-xs border rounded-md hover:bg-gray-50">
                                                                <i data-lucide="download" class="w-3.5 h-3.5 mr-1"></i>
                                                                Download
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Evidence Card 3: Image -->
                                                <div class="rounded-lg bg-white border overflow-hidden">
                                                    <div
                                                        class="aspect-video bg-gray-100 flex items-center justify-center overflow-hidden">
                                                        <img src="https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=800&auto=format&fit=crop"
                                                            alt="Payment Confirmation"
                                                            class="w-full h-full object-cover">
                                                    </div>
                                                    <div class="p-3">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <p class="text-sm font-medium text-gray-900">
                                                                    confirmation.jpg</p>
                                                                <p class="text-xs text-gray-500">980 KB • Uploaded Nov
                                                                    26, 2025</p>
                                                            </div>
                                                            <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                                                        </div>
                                                        <div class="mt-3 flex items-center gap-2">
                                                            <button type="button"
                                                                onclick="openEvidenceViewer('https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop')"
                                                                class="inline-flex items-center px-3 py-1.5 text-xs border rounded-md hover:bg-gray-50">
                                                                <i data-lucide="eye" class="w-3.5 h-3.5 mr-1"></i>
                                                                View
                                                            </button>
                                                            <a href="https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"
                                                                download target="_blank" rel="noopener noreferrer"
                                                                class="inline-flex items-center px-3 py-1.5 text-xs border rounded-md hover:bg-gray-50">
                                                                <i data-lucide="download" class="w-3.5 h-3.5 mr-1"></i>
                                                                Download
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal Footer -->
                                <div
                                    class="bg-gray-50 px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                    <div class="text-xs text-gray-500">Last updated: Apr 10, 2025 at 2:30 PM</div>
                                    <div class="flex justify-end gap-3">
                                        <button
                                            class="inline-flex items-center px-3 py-1.5 border border-red-600 text-red-700 hover:bg-red-50 rounded-md text-sm font-medium">
                                            <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                            Mark as Paid
                                        </button>
                                        <button onclick="closePaymentDetails()"
                                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Evidence Viewer Modal -->
                    <div id="evidence-viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50">
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-lg shadow-2xl w-full max-w-5xl overflow-hidden">
                                <!-- Header -->
                                <div class="flex items-center justify-between px-4 py-3 border-b">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="paperclip" class="w-5 h-5 text-gray-500"></i>
                                        <h3 class="text-base font-semibold text-gray-900">Evidence Preview</h3>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a id="evidence-download" href="#" download target="_blank"
                                            rel="noopener noreferrer"
                                            class="px-3 py-1.5 text-sm border rounded-md hover:bg-gray-50 inline-flex items-center">
                                            <i data-lucide="download" class="w-4 h-4 mr-1"></i>
                                            Download
                                        </a>
                                        <button onclick="closeEvidenceViewer()"
                                            class="text-gray-500 hover:text-gray-700 p-1.5 rounded">
                                            <i data-lucide="x" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Body -->
                                <div class="bg-black">
                                    <div class="w-full h-[70vh] flex items-center justify-center bg-black">
                                        <img id="evidence-image" src="" alt="Evidence Image"
                                            class="hidden max-h-full max-w-full object-contain" />
                                        <iframe id="evidence-pdf" src="" class="hidden w-full h-full"
                                            title="Evidence PDF"></iframe>
                                    </div>
                                </div>
                                <!-- Footer -->
                                <div class="px-4 py-3 bg-white border-t flex items-center justify-between">
                                    <p id="evidence-file-name" class="text-xs text-gray-500 truncate"></p>
                                    <a id="evidence-open-new" href="#" target="_blank"
                                        class="text-sm text-red-600 hover:text-red-700 inline-flex items-center">
                                        <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                                        Open in new tab
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Create Invoice Modal -->
                    <div id="create_invoice_modal"
                        class="hidden fixed inset-0 bg-black bg-opacity-60 overflow-y-auto z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-y-auto">
                            <!-- Modal Header -->
                            <div
                                class="sticky top-0 bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-5 rounded-t-2xl z-10">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-2xl font-bold flex items-center gap-3">
                                            <i data-lucide="file-text" class="w-7 h-7"></i>
                                            Create New Invoice
                                        </h3>
                                        <p class="text-red-100 text-sm mt-1">Generate invoice with automatic payment
                                            breakdown</p>
                                    </div>
                                    <button onclick="closeCreateInvoiceModal()" type="button"
                                        class="text-white hover:bg-red-800 p-2 rounded-lg transition-colors">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <!-- Progress Steps -->
                                <div class="flex items-center justify-center mt-6 gap-2">
                                    <div class="flex items-center" id="step_indicator_1">
                                        <div
                                            class="flex items-center justify-center w-10 h-10 rounded-full bg-white text-red-600 font-bold">
                                            1</div>
                                        <span class="ml-2 text-sm font-medium">Student</span>
                                    </div>
                                    <div class="w-16 h-1 bg-red-400 mx-2"></div>
                                    <div class="flex items-center opacity-50" id="step_indicator_2">
                                        <div
                                            class="flex items-center justify-center w-10 h-10 rounded-full bg-red-400 text-white font-bold">
                                            2</div>
                                        <span class="ml-2 text-sm font-medium">Payment</span>
                                    </div>
                                    <div class="w-16 h-1 bg-red-400 mx-2"></div>
                                    <div class="flex items-center opacity-50" id="step_indicator_3">
                                        <div
                                            class="flex items-center justify-center w-10 h-10 rounded-full bg-red-400 text-white font-bold">
                                            3</div>
                                        <span class="ml-2 text-sm font-medium">Preview</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal Body -->
                            <div class="p-6">
                                <!-- Step 1: Student Selection -->
                                <div id="invoice_step_1" class="space-y-6">
                                    <div class="bg-gray-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                                        <p class="text-sm text-gray-700">
                                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                            Select the student and application to generate an invoice
                                        </p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Student Selection -->
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                                                Select Student <span class="text-red-600">*</span>
                                            </label>
                                            <select id="invoice_student" required
                                                onchange="loadStudentApplications(this.value)"
                                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all">
                                                <option value="">Choose a student...</option>
                                                <option value="STU001">Nguyễn Văn A - an.nguyen@email.com</option>
                                                <option value="STU002">Trần Thị B - binh.tran@email.com</option>
                                                <option value="STU003">Lê Hoàng C - cuong.le@email.com</option>
                                                <option value="STU004">Phạm Minh D- duc.pham@email.com</option>
                                            </select>
                                        </div>

                                        <!-- Application Selection (Multi-select with Checkboxes) -->
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                                                Select Application <span class="text-red-600">*</span>
                                            </label>
                                            <div class="relative">
                                                <button type="button" id="application_dropdown_btn"
                                                    onclick="toggleApplicationDropdown()"
                                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all bg-white text-left flex items-center justify-between">
                                                    <span id="application_dropdown_label" class="text-gray-500">Select
                                                        student first...</span>
                                                    <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400"></i>
                                                </button>
                                                <div id="application_dropdown_menu"
                                                    class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                                                    <div id="application_options_list" class="p-2">
                                                        <p class="px-3 py-2 text-sm text-gray-500">Select a student
                                                            first</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="mt-1 text-xs text-gray-500">Select one or more applications to
                                                combine in one invoice</p>
                                        </div>
                                    </div>

                                    <!-- Application Details (One card per selected application) -->
                                    <div id="application_details_container" class="hidden space-y-3">
                                        <h4 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                            <i data-lucide="layers" class="w-5 h-5 text-red-600"></i>
                                            Application Details
                                        </h4>
                                        <div id="application_details_list" class="space-y-3">
                                            <!-- Application detail cards will be rendered here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2: Payment Details (Hidden initially) -->
                                <div id="invoice_step_2" class="hidden space-y-6">
                                    <div class="bg-gray-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                                        <p class="text-sm text-gray-700">
                                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                            Enter payment stage, amount and due date for each selected application
                                        </p>
                                    </div>

                                    <!-- Dynamic Sections: One per selected application -->
                                    <div>
                                        <h4 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                            <i data-lucide="layers" class="w-5 h-5 text-red-600"></i>
                                            Application Payments
                                        </h4>
                                        <div id="application_payments_container" class="space-y-4">
                                            <!-- Sections will be rendered here by JS -->
                                        </div>
                                    </div>

                                    <!-- Invoice Total (sum of application amounts) -->
                                    <div class="flex justify-end">
                                        <div class="w-full md:w-80">
                                            <div class="flex justify-between py-2 border-t-2 border-gray-800">
                                                <p class="font-bold text-lg">Total Amount:</p>
                                                <p id="invoice_total_amount_sum" class="font-bold text-2xl"
                                                    style="color:#d82128;">$0.00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: Invoice Preview (Hidden initially) -->
                                <div id="invoice_step_3" class="hidden space-y-6">
                                    <div
                                        class="bg-gradient-to-r from-red-50 to-emerald-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                                        <p class="text-sm text-gray-700 font-medium">
                                            <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                            Review invoice before sending to student
                                        </p>
                                    </div>

                                    <!-- Invoice Preview Card -->
                                    <div class="bg-white border-2 border-gray-300 rounded-xl shadow-lg p-8"
                                        id="invoice_preview_container">
                                        <!-- Invoice Header -->
                                        <div class="flex items-start justify-between mb-8 pb-6 border-b-2">
                                            <div>
                                                <h2 class="text-3xl font-bold" style="color:#d82128;">INVOICE</h2>
                                                <p class="text-sm text-gray-600 mt-1">ApplyLead Education Services</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm text-gray-600">Invoice Number</p>
                                                <p class="text-lg font-bold" id="preview_invoice_number">INV-2025-001
                                                </p>
                                                <p class="text-xs text-gray-500 mt-2" id="preview_date">Date: -</p>
                                            </div>
                                        </div>

                                        <!-- Student Info -->
                                        <div class="mb-6">
                                            <p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Bill To:</p>
                                            <p class="font-bold text-gray-900" id="preview_student_name">-</p>
                                            <p class="text-sm text-gray-600" id="preview_student_email">-</p>
                                        </div>

                                        <!-- Invoice Items -->
                                        <table class="w-full mb-6">
                                            <thead>
                                                <tr class="border-b-2 border-gray-300">
                                                    <th class="text-left py-2 text-sm font-semibold text-gray-700">
                                                        Description</th>
                                                    <th class="text-right py-2 text-sm font-semibold text-gray-700">
                                                        Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="preview_items_body">
                                                <!-- Items will be rendered here -->
                                            </tbody>
                                        </table>

                                        <!-- Total -->
                                        <div class="flex justify-end mb-6">
                                            <div class="w-64">
                                                <div class="flex justify-between py-2 border-t-2 border-gray-800">
                                                    <p class="font-bold text-lg">Total Amount:</p>
                                                    <p class="font-bold text-2xl" style="color:#d82128;"
                                                        id="preview_total">$0.00</p>
                                                </div>
                                                <p class="text-xs text-gray-600 text-right mt-1" id="preview_due_date">
                                                    Due: -</p>
                                            </div>
                                        </div>

                                        <!-- Payment Instructions -->
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <p class="text-sm font-semibold text-gray-700 mb-2">Payment Instructions:
                                            </p>
                                            <p class="text-xs text-gray-600" id="preview_payment_method">-</p>
                                        </div>
                                    </div>

                                    <!-- Send Options -->
                                    <div class="flex items-center gap-3 p-4 bg-red-50 border border-red-200 rounded-lg">
                                        <input type="checkbox" id="send_email_notification" checked
                                            class="w-5 h-5 rounded" style="accent-color:#d82128;">
                                        <label for="send_email_notification"
                                            class="text-sm font-medium text-gray-700 cursor-pointer">
                                            Send email notification to student
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal Footer -->
                            <div
                                class="sticky bottom-0 bg-gray-50 px-6 py-4 border-t-2 flex justify-between items-center rounded-b-2xl">
                                <button onclick="previousInvoiceStep()" type="button" id="btn_previous"
                                    class="hidden px-5 py-2.5 border-2 border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-all">
                                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
                                    Previous
                                </button>
                                <div class="flex gap-3 ml-auto">
                                    <button onclick="closeCreateInvoiceModal()" type="button"
                                        class="px-5 py-2.5 border-2 border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition-all">
                                        Cancel
                                    </button>
                                    <button onclick="nextInvoiceStep()" type="button" id="btn_next"
                                        class="px-6 py-2.5 rounded-lg font-semibold text-white flex items-center gap-2 shadow-lg hover:shadow-xl transition-all"
                                        style="background: linear-gradient(135deg, #d82128 0%, #a01820 100%);">
                                        Next Step
                                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- End Tab: Payments Overview -->

                <!-- Tab Content: Payment Config -->
                <div id="tab-config" class="payment-tab-content hidden">
                    <!-- Payment Order Management Section -->
                    <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i data-lucide="list-ordered" class="w-5 h-5 mr-2" style="color:#d82128;"></i>
                                    Payment Order Management
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">Manage payment installment orders (1st, 2nd, 3rd,
                                    etc.)</p>
                            </div>
                            <button type="button" onclick="openAddPaymentOrderModal()"
                                class="px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center gap-2"
                                style="background-color:#d82128;">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Add Payment Order
                            </button>
                        </div>

                        <!-- Payment Orders Table -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Display Name
                                        </th>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Description
                                        </th>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Payment Type
                                        </th>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Applicable Step
                                        </th>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status
                                        </th>
                                        <th
                                            class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="payment_orders_table_body">
                                    <!-- Sample Row 1 -->
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="text-sm font-medium text-gray-900">First Payment</div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="text-sm text-gray-600">Initial payment installment</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Application</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border">Initial
                                                Advising</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="flex items-center cursor-pointer select-none"
                                                onclick="toggleStatusCell(1)" role="switch" aria-checked="true">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input id="po_status_toggle_1" type="checkbox" class="sr-only peer"
                                                        onchange="togglePaymentOrderStatus(1)" checked>
                                                    <div
                                                        class="relative w-11 h-6 rounded-full bg-gray-200 transition-colors duration-200 ease-in-out peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-600 before:content-[''] before:absolute before:top-0.5 before:left-0.5 before:h-5 before:w-5 before:bg-white before:border before:border-gray-300 before:rounded-full before:transition-transform before:duration-200 before:ease-in-out peer-checked:before:translate-x-5">
                                                    </div>
                                                </label>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editPaymentOrder(1)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deletePaymentOrder(1)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Sample Row 2 -->
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="text-sm font-medium text-gray-900">Second Payment</div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="text-sm text-gray-600">Second payment installment</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Application</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border">Submitted
                                                to School</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="flex items-center cursor-pointer select-none"
                                                onclick="toggleStatusCell(2)" role="switch" aria-checked="true">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input id="po_status_toggle_2" type="checkbox" class="sr-only peer"
                                                        onchange="togglePaymentOrderStatus(2)" checked>
                                                    <div
                                                        class="relative w-11 h-6 rounded-full bg-gray-200 transition-colors duration-200 ease-in-out peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-600 before:content-[''] before:absolute before:top-0.5 before:left-0.5 before:h-5 before:w-5 before:bg-white before:border before:border-gray-300 before:rounded-full before:transition-transform before:duration-200 before:ease-in-out peer-checked:before:translate-x-5">
                                                    </div>
                                                </label>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editPaymentOrder(2)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deletePaymentOrder(2)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Sample Row 3 -->
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="text-sm font-medium text-gray-900">Third Payment</div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="text-sm text-gray-600">Third payment installment</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Application</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border">Offer
                                                Letter Issued</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="flex items-center cursor-pointer select-none"
                                                onclick="toggleStatusCell(3)" role="switch" aria-checked="true">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input id="po_status_toggle_3" type="checkbox" class="sr-only peer"
                                                        onchange="togglePaymentOrderStatus(3)" checked>
                                                    <div
                                                        class="relative w-11 h-6 rounded-full bg-gray-200 transition-colors duration-200 ease-in-out peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-600 before:content-[''] before:absolute before:top-0.5 before:left-0.5 before:h-5 before:w-5 before:bg-white before:border before:border-gray-300 before:rounded-full before:transition-transform before:duration-200 before:ease-in-out peer-checked:before:translate-x-5">
                                                    </div>
                                                </label>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editPaymentOrder(3)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deletePaymentOrder(3)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Sample Row 4 (Service Payment) -->
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="text-sm font-medium text-gray-900">Service Fee</div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="text-sm text-gray-600">One-time counseling service</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Service</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span class="text-xs text-gray-400">N/A</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="flex items-center cursor-pointer select-none"
                                                onclick="toggleStatusCell(4)" role="switch" aria-checked="true">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input id="po_status_toggle_4" type="checkbox" class="sr-only peer"
                                                        onchange="togglePaymentOrderStatus(4)" checked>
                                                    <div
                                                        class="relative w-11 h-6 rounded-full bg-gray-200 transition-colors duration-200 ease-in-out peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-600 before:content-[''] before:absolute before:top-0.5 before:left-0.5 before:h-5 before:w-5 before:bg-white before:border before:border-gray-300 before:rounded-full before:transition-transform before:duration-200 before:ease-in-out peer-checked:before:translate-x-5">
                                                    </div>
                                                </label>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editPaymentOrder(4)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deletePaymentOrder(4)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Sample Row 5 (Service Payment - Inactive) -->
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="text-sm font-medium text-gray-900">Additional Service Fee</div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="text-sm text-gray-600">Optional visa consulting add-on</div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Service</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span class="text-xs text-gray-400">N/A</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="flex items-center cursor-pointer select-none"
                                                onclick="toggleStatusCell(5)" role="switch" aria-checked="false">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input id="po_status_toggle_5" type="checkbox" class="sr-only peer"
                                                        onchange="togglePaymentOrderStatus(5)">
                                                    <div
                                                        class="relative w-11 h-6 rounded-full bg-gray-200 transition-colors duration-200 ease-in-out peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-600 before:content-[''] before:absolute before:top-0.5 before:left-0.5 before:h-5 before:w-5 before:bg-white before:border before:border-gray-300 before:rounded-full before:transition-transform before:duration-200 before:ease-in-out peer-checked:before:translate-x-5">
                                                    </div>
                                                </label>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editPaymentOrder(5)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>

                                            <button onclick="deletePaymentOrder(5)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Add Payment Order Modal -->
                        <div id="add_payment_order_modal" class="hidden fixed inset-0 bg-black/40 z-50">
                            <div class="min-h-full w-full flex items-center justify-center p-4">
                                <div class="bg-white rounded-lg shadow-xl max-w-xl w-full">
                                    <div class="flex items-center justify-between p-6 border-b">
                                        <h3 class="text-lg font-semibold text-gray-900">Add Payment Order</h3>
                                        <button onclick="closeAddPaymentOrderModal()"
                                            class="text-gray-400 hover:text-gray-600">
                                            <i data-lucide="x" class="w-6 h-6"></i>
                                        </button>
                                    </div>
                                    <div class="p-6 space-y-5">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Display
                                                Name</label>
                                            <input id="po_display_name" type="text" placeholder="e.g., First Payment"
                                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" />
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                            <input id="po_description" type="text" placeholder="Short description"
                                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment
                                                Type</label>
                                            <div class="flex items-center gap-6">
                                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                                    <input type="radio" name="po_payment_type" id="po_type_application"
                                                        value="application" class="w-4 h-4"
                                                        onchange="setApplicableStepVisibility()">
                                                    <span>Application payment</span>
                                                </label>
                                                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                                                    <input type="radio" name="po_payment_type" id="po_type_service"
                                                        value="service" class="w-4 h-4"
                                                        onchange="setApplicableStepVisibility()">
                                                    <span>Service payment</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="po_applicable_step_container" class="hidden">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Applicable
                                                Step</label>
                                            <select id="po_applicable_step"
                                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm">
                                                <option value="">-- Select Step --</option>
                                                <option value="Initial Advising">Initial Advising</option>
                                                <option value="Application In Progress">Application In Progress</option>
                                                <option value="Submitted to School">Submitted to School</option>
                                                <option value="School Response">School Response</option>
                                                <option value="Offer Letter Issued">Offer Letter Issued</option>
                                                <option value="Committed to School">Committed to School</option>
                                                <option value="Visa Application">Visa Application</option>
                                                <option value="Pre-Departure">Pre-Departure</option>
                                                <option value="Arrival">Arrival</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                                        <button type="button" onclick="closeAddPaymentOrderModal()"
                                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                                        <button type="button" onclick="closeAddPaymentOrderModal()"
                                            class="px-6 py-2 text-sm font-medium text-white rounded-lg"
                                            style="background-color:#d82128;">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                            function togglePaymentOrderStatus(id) {
                                const toggle = document.getElementById(`po_status_toggle_${id}`);
                                if (!toggle) return;
                                // Persist or side-effects can be added here (e.g., API call)
                            }
                            function toggleStatusCell(id) {
                                const toggle = document.getElementById(`po_status_toggle_${id}`);
                                if (!toggle) return;
                                toggle.checked = !toggle.checked;
                                // update aria-checked on container for accessibility
                                const container = toggle.closest('[role="switch"]');
                                if (container) container.setAttribute('aria-checked', String(toggle.checked));
                                togglePaymentOrderStatus(id);
                            }
                            function setApplicableStepVisibility() {
                                const app = document.getElementById('po_type_application');
                                const svc = document.getElementById('po_type_service');
                                const isApplication = app && app.checked === true;
                                const isService = svc && svc.checked === true;
                                const container = document.getElementById('po_applicable_step_container');
                                const select = document.getElementById('po_applicable_step');
                                if (container && select) {
                                    if (isService || !isApplication) {
                                        container.classList.add('hidden');
                                        container.style.display = 'none';
                                        select.removeAttribute('required');
                                        select.value = '';
                                    } else {
                                        container.classList.remove('hidden');
                                        container.style.display = '';
                                        select.setAttribute('required', 'required');
                                    }
                                }
                            }

                            function bindPaymentTypeToggle() {
                                const app = document.getElementById('po_type_application');
                                const svc = document.getElementById('po_type_service');
                                if (app) {
                                    app.addEventListener('change', setApplicableStepVisibility);
                                    app.addEventListener('input', setApplicableStepVisibility);
                                    app.addEventListener('click', setApplicableStepVisibility);
                                }
                                if (svc) {
                                    svc.addEventListener('change', setApplicableStepVisibility);
                                    svc.addEventListener('input', setApplicableStepVisibility);
                                    svc.addEventListener('click', setApplicableStepVisibility);
                                }
                                setApplicableStepVisibility();
                            }

                            function openAddPaymentOrderModal() {
                                const el = document.getElementById('add_payment_order_modal');
                                if (el) {
                                    el.classList.remove('hidden');
                                    // reset: no default selection
                                    const app = document.getElementById('po_type_application');
                                    const svc = document.getElementById('po_type_service');
                                    if (app) app.checked = false;
                                    if (svc) svc.checked = false;
                                    bindPaymentTypeToggle();
                                    // ensure initial state hidden
                                    setApplicableStepVisibility();
                                }
                            }
                            function closeAddPaymentOrderModal() {
                                const el = document.getElementById('add_payment_order_modal');
                                if (el) el.classList.add('hidden');
                            }
                            // Ensure initial hidden state on load
                            document.addEventListener('DOMContentLoaded', function () {
                                setApplicableStepVisibility();
                            });
                        </script>
                    </div>

                </div>
                <!-- End Tab: Payment Config -->

                <!-- Tab Content: Agent Commission -->
                <div id="tab-commission" class="payment-tab-content hidden">
                    <!-- Header with Add Button -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 flex items-center">
                                <i data-lucide="users" class="w-6 h-6 mr-2" style="color:#d82128;"></i>
                                Agent Commission Configuration
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">Configure commission rates for different agent levels
                                and programs</p>
                        </div>
                        <button type="button" onclick="openAddCommissionModal()"
                            class="px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center gap-2"
                            style="background-color:#d82128;">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Commission
                        </button>
                    </div>

                    <!-- Informational Note -->
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="info" class="w-5 h-5 text-red-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-800">
                                    <strong>Important:</strong> Commission is triggered automatically after the
                                    <strong>Third Payment</strong> from the student is verified and marked as paid.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Commission Table -->
                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                            <!-- Expand/Collapse column -->
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Program Name
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Type
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            LA (Local Agent)
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            L1 (Level 1)
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            L2 (Level 2)
                                        </th>
                                        <th
                                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white" id="commission_table_body">
                                    <!-- Sample Row 1 - EF Scholarship -->
                                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <button onclick="toggleParentDetails(1)"
                                                class="text-gray-500 hover:text-gray-700 transition-transform duration-200"
                                                id="expand_btn_1">
                                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                            </button>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">EF Scholarship Guarantee
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                Percentage
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">20%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">30%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">40%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editCommission(1)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deleteCommission(1)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Expandable Parent Agent Details Row 1 -->
                                    <tr id="parent_details_1" class="hidden bg-gray-50">
                                        <td colspan="7" class="px-4 py-4">
                                            <div class="ml-10 mr-6 p-4 bg-white border border-gray-200 rounded-lg">
                                                <div class="flex items-center gap-2 mb-3">
                                                    <i data-lucide="git-branch" class="w-4 h-4 text-red-600"></i>
                                                    <h4 class="text-sm font-semibold text-gray-900">Parent Agent
                                                        Commission Configuration</h4>
                                                </div>
                                                <div class="space-y-2 ml-6">
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">├─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">L1</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">10%</span>
                                                        <span class="text-gray-500 text-xs">when LA completes a
                                                            sale</span>
                                                    </div>
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">└─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">L2</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">5%</span>
                                                        <span class="text-gray-500 text-xs">when LA completes a
                                                            sale</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Sample Row 2 - Elite Admission -->
                                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <button onclick="toggleParentDetails(2)"
                                                class="text-gray-500 hover:text-gray-700 transition-transform duration-200"
                                                id="expand_btn_2">
                                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                            </button>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">Elite Admission</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                Percentage
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">20%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">30%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">40%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editCommission(2)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deleteCommission(2)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Expandable Parent Agent Details Row 2 -->
                                    <tr id="parent_details_2" class="hidden bg-gray-50">
                                        <td colspan="7" class="px-4 py-4">
                                            <div class="ml-10 mr-6 p-4 bg-white border border-gray-200 rounded-lg">
                                                <div class="flex items-center gap-2 mb-3">
                                                    <i data-lucide="git-branch" class="w-4 h-4 text-red-600"></i>
                                                    <h4 class="text-sm font-semibold text-gray-900">Parent Agent
                                                        Commission Configuration</h4>
                                                </div>
                                                <div class="space-y-2 ml-6">
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">├─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">L1</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">12%</span>
                                                        <span class="text-gray-500 text-xs">when LA completes a
                                                            sale</span>
                                                    </div>
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">└─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">L2</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">8%</span>
                                                        <span class="text-gray-500 text-xs">when LA completes a
                                                            sale</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Sample Row 3 - Ivy Global Package A -->
                                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <button onclick="toggleParentDetails(3)"
                                                class="text-gray-500 hover:text-gray-700 transition-transform duration-200"
                                                id="expand_btn_3">
                                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                            </button>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">Ivy Global - Package A</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                Fixed Amount
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$3,000</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$4,000</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$5,000</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editCommission(3)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deleteCommission(3)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Expandable Parent Agent Details Row 3 -->
                                    <tr id="parent_details_3" class="hidden bg-gray-50">
                                        <td colspan="7" class="px-4 py-4">
                                            <div class="ml-10 mr-6 p-4 bg-white border border-gray-200 rounded-lg">
                                                <div class="flex items-center gap-2 mb-3">
                                                    <i data-lucide="git-branch" class="w-4 h-4 text-red-600"></i>
                                                    <h4 class="text-sm font-semibold text-gray-900">Parent Agent
                                                        Commission Configuration</h4>
                                                </div>
                                                <div class="space-y-2 ml-6">
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">├─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">L1</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">$1,500</span>
                                                        <span class="text-gray-500 text-xs">when LA completes a
                                                            sale</span>
                                                    </div>
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">└─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">L2</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">$1,000</span>
                                                        <span class="text-gray-500 text-xs">when LA completes a
                                                            sale</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Sample Row 4 - Ivy Global Package B -->
                                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <button onclick="toggleParentDetails(4)"
                                                class="text-gray-500 hover:text-gray-700 transition-transform duration-200"
                                                id="expand_btn_4">
                                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                            </button>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">Ivy Global - Package B</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                Fixed Amount
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$3,500</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$4,500</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$5,500</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editCommission(4)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deleteCommission(4)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Expandable Parent Agent Details Row 4 -->
                                    <tr id="parent_details_4" class="hidden bg-gray-50">
                                        <td colspan="7" class="px-4 py-4">
                                            <div class="ml-10 mr-6 p-4 bg-white border border-gray-200 rounded-lg">
                                                <div class="flex items-center gap-2 mb-3">
                                                    <i data-lucide="git-branch" class="w-4 h-4 text-red-600"></i>
                                                    <h4 class="text-sm font-semibold text-gray-900">Parent Agent
                                                        Commission Configuration</h4>
                                                </div>
                                                <div class="space-y-2 ml-6">
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="text-gray-400">└─</span>
                                                        <span
                                                            class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">L2</span>
                                                        <span class="text-gray-700">receives</span>
                                                        <span class="font-semibold text-gray-900">$1,500</span>
                                                        <span class="text-gray-500 text-xs">when L1 completes a
                                                            sale</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Sample Row 5 - Ivy Global Package C (L2 - No Parents) -->
                                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                                        <td class="px-4 py-4 whitespace-nowrap">
                                            <!-- No expand button for L2 since it has no parents -->
                                            <div class="w-5 h-5"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">Ivy Global - Package C</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                Fixed Amount
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$4,000</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$5,000</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">$6,000</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="editCommission(5)"
                                                class="text-gray-900 hover:text-gray-700 mr-3">
                                                <i data-lucide="edit" class="w-4 h-4 inline"></i>
                                            </button>
                                            <button onclick="deleteCommission(5)"
                                                class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- End Tab: Agent Commission -->

                <!-- Add/Edit Payment Order Modal -->
                <div id="add_payment_order_modal"
                    class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 overflow-y-auto z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between p-6 border-b">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900" id="payment_order_modal_title">Add
                                        Payment Order</h3>
                                    <p class="text-sm text-gray-500 mt-1">Create a new payment installment order</p>
                                </div>
                                <button onclick="closeAddPaymentOrderModal()" class="text-gray-400 hover:text-gray-500">
                                    <i data-lucide="x" class="h-6 w-6"></i>
                                </button>
                            </div>

                            <!-- Modal Content -->
                            <div class="p-6">
                                <form id="payment_order_form" class="space-y-6">
                                    <!-- Display Name -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Display Name <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="order_display_name" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                            placeholder="e.g., First Payment, Second Payment">
                                        <p class="text-xs text-gray-500 mt-1">How this order will appear in dropdowns
                                        </p>
                                    </div>

                                    <!-- Description -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Description
                                        </label>
                                        <textarea id="order_description" rows="3"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                            placeholder="Brief description of this payment order..."></textarea>
                                    </div>

                                    <!-- Status -->
                                    <div>
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" id="order_status" checked class="w-4 h-4 rounded"
                                                style="accent-color:#d82128;" />
                                            <span class="text-sm font-medium text-gray-700">Active (Available for
                                                selection)</span>
                                        </label>
                                    </div>
                                </form>
                            </div>

                            <!-- Modal Footer -->
                            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                                <button type="button" onclick="closeAddPaymentOrderModal()"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="savePaymentOrder()"
                                    class="px-6 py-2 text-sm font-medium text-white rounded-lg"
                                    style="background-color:#d82128;">
                                    <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                    Save Order
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Commission Modal -->
                <div id="add_commission_modal"
                    class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 overflow-y-auto z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                            <!-- Modal Header -->
                            <div class="flex items-center justify-between p-6 border-b">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900" id="commission_modal_title">Add
                                        Commission Configuration</h3>
                                    <p class="text-sm text-gray-500 mt-1">Configure commission rates for agent levels
                                    </p>
                                </div>
                                <button onclick="closeAddCommissionModal()" class="text-gray-400 hover:text-gray-500">
                                    <i data-lucide="x" class="h-6 w-6"></i>
                                </button>
                            </div>

                            <!-- Modal Content -->
                            <div class="p-6">
                                <form id="commission_form" class="space-y-6">
                                    <!-- Program Name -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Program Name <span class="text-red-500">*</span>
                                        </label>
                                        <select id="commission_program_code" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                            <option value="">-- Select Program Name --</option>
                                            <option value="SP1A">EF Scholarship Guarantee</option>
                                            <option value="SP2">Elite Admission</option>
                                            <option value="SP3A">Ivy Global - Package A</option>
                                            <option value="SP3B">Ivy Global - Package B</option>
                                            <option value="SP3C">Ivy Global - Package C</option>
                                        </select>
                                    </div>

                                    <!-- Agent Level Selection -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Agent Level <span class="text-red-500">*</span>
                                        </label>
                                        <select id="commission_agent_level" required
                                            onchange="renderParentAgentSections()"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                            <option value="">-- Select Agent Level --</option>
                                            <option value="LA">LA - Local Agent (has 2 parent agents: L1, L2)</option>
                                            <option value="L1">L1 - Level 1 Agent (has 1 parent agent: L2)</option>
                                            <option value="L2">L2 - Level 2 Agent (no parent agents)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">
                                            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                            Hierarchy: LA → L1 → L2
                                        </p>
                                    </div>

                                    <!-- Commission Type -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-3">
                                            Commission Type <span class="text-red-500">*</span>
                                        </label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <label
                                                class="relative flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-all"
                                                id="percentage_commission_option">
                                                <input type="radio" name="commission_type" value="percentage"
                                                    onchange="toggleCommissionTypeInput('percentage')" class="w-4 h-4"
                                                    style="accent-color:#d82128;" />
                                                <div class="ml-3 flex-1">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="percent" class="w-4 h-4 text-gray-600"></i>
                                                        <span class="font-medium text-gray-900">Percentage</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-1">Commission as % of scholarship
                                                        value</p>
                                                </div>
                                            </label>
                                            <label
                                                class="relative flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-all"
                                                id="fixed_commission_option">
                                                <input type="radio" name="commission_type" value="fixed"
                                                    onchange="toggleCommissionTypeInput('fixed')" class="w-4 h-4"
                                                    style="accent-color:#d82128;" />
                                                <div class="ml-3 flex-1">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="dollar-sign" class="w-4 h-4 text-gray-600"></i>
                                                        <span class="font-medium text-gray-900">Fixed Amount</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-1">Fixed dollar amount</p>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Primary Agent Commission -->
                                    <div class="border-t pt-4" id="primary_agent_section">
                                        <h4 class="text-sm font-medium text-gray-900 mb-4 flex items-center gap-2">
                                            <i data-lucide="user" class="w-4 h-4" style="color:#d82128;"></i>
                                            Primary Agent Commission
                                        </h4>
                                        <div class="grid grid-cols-3 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    LA (Local Agent) <span class="text-red-500">*</span>
                                                </label>
                                                <div class="relative">
                                                    <span class="absolute left-3 top-2.5 text-gray-500 text-sm"
                                                        id="la_prefix">%</span>
                                                    <input type="number" id="commission_la" required
                                                        class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                                        placeholder="0" min="0" step="0.01">
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    L1 (Level 1) <span class="text-red-500">*</span>
                                                </label>
                                                <div class="relative">
                                                    <span class="absolute left-3 top-2.5 text-gray-500 text-sm"
                                                        id="l1_prefix">%</span>
                                                    <input type="number" id="commission_l1" required
                                                        class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                                        placeholder="0" min="0" step="0.01">
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    L2 (Level 2) <span class="text-red-500">*</span>
                                                </label>
                                                <div class="relative">
                                                    <span class="absolute left-3 top-2.5 text-gray-500 text-sm"
                                                        id="l2_prefix">%</span>
                                                    <input type="number" id="commission_l2" required
                                                        class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                                        placeholder="0" min="0" step="0.01">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Parent Agent Sections (Dynamic) -->
                                    <div id="parent_agents_container" class="space-y-4">
                                        <!-- Parent agent sections will be rendered here dynamically -->
                                    </div>
                                </form>
                            </div>

                            <!-- Modal Footer -->
                            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                                <button type="button" onclick="closeAddCommissionModal()"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="saveCommission()"
                                    class="px-6 py-2 text-sm font-medium text-white rounded-lg"
                                    style="background-color:#d82128;">
                                    <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                    Save Commission
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success/Error Toast Notification -->
                <div id="toast_notification" class="hidden fixed bottom-4 right-4 z-50">
                    <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-md" id="toast_content">
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle" class="w-5 h-5 flex-shrink-0" id="toast_icon"></i>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900" id="toast_title">Success</p>
                                <p class="text-sm text-gray-500 mt-1" id="toast_message">Payment configuration saved
                                    successfully</p>
                            </div>
                            <button onclick="closeToast()" class="text-gray-400 hover:text-gray-500">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Modal Functions
        function openAddPaymentModal() {
            document.getElementById('add_payment_modal').classList.remove('hidden');
            document.getElementById('modal_title').textContent = 'Add Payment Configuration';
            document.getElementById('payment_config_form').reset();
            lucide.createIcons();
        }

        // When admin edits Student Payment directly in Step 3, sync total and recalc breakdown
        function recalcTotalFromStudent() {
            const inputStudent = document.getElementById('input_student_amount');
            const totalEl = document.getElementById('invoice_total_amount');
            if (!inputStudent || !totalEl) return;
            const amt = parseCurrency(inputStudent.value);
            if (isNaN(amt) || amt < 0) return;
            totalEl.value = amt.toFixed(2);
            // If admin already set ApplyLead/Commission, recompute scholarship remainder
            if (document.getElementById('input_applylead') || document.getElementById('input_commission')) {
                recalcManualBreakdown();
            } else {
                calculateBreakdown();
            }
        }

        function closeAddPaymentModal() {
            document.getElementById('add_payment_modal').classList.add('hidden');
        }

        function editPaymentConfig(id) {
            document.getElementById('add_payment_modal').classList.remove('hidden');
            document.getElementById('modal_title').textContent = 'Edit Payment Configuration';
            // Load existing data here
            lucide.createIcons();
        }

        function togglePaymentTypeInput(type) {
            const fixedWrapper = document.getElementById('fixed_amount_input_wrapper');
            const percentageWrapper = document.getElementById('percentage_input_wrapper');
            const fixedOption = document.getElementById('fixed_amount_option');
            const percentageOption = document.getElementById('percentage_option');

            if (type === 'fixed_amount') {
                fixedWrapper.style.display = 'block';
                percentageWrapper.style.display = 'none';
                fixedOption.classList.add('border-red-500', 'bg-red-50');
                percentageOption.classList.remove('border-red-500', 'bg-red-50');
                document.getElementById('modal_fixed_amount').required = true;
                document.getElementById('modal_percentage').required = false;
            } else {
                fixedWrapper.style.display = 'none';
                percentageWrapper.style.display = 'block';
                percentageOption.classList.add('border-red-500', 'bg-red-50');
                fixedOption.classList.remove('border-red-500', 'bg-red-50');
                document.getElementById('modal_percentage').required = true;
                document.getElementById('modal_fixed_amount').required = false;
            }
        }

        function savePaymentConfiguration() {
            // Validate form
            const form = document.getElementById('payment_config_form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get form data
            const data = {
                program_type: document.getElementById('modal_program_type').value,
                payment_order: document.getElementById('modal_payment_order').value,
                application_step: document.getElementById('modal_application_step').value,
                payment_type: document.querySelector('input[name="payment_type"]:checked').value,
                value: document.querySelector('input[name="payment_type"]:checked').value === 'fixed_amount'
                    ? document.getElementById('modal_fixed_amount').value
                    : document.getElementById('modal_percentage').value,
                status: document.getElementById('modal_status').checked ? 'active' : 'inactive',
                notes: document.getElementById('modal_notes').value
            };

            console.log('Saving payment configuration:', data);

            // TODO: Send to backend API
            // Example: fetch('/api/payment-config', { method: 'POST', body: JSON.stringify(data) })

            // Show success toast
            showToast('success', 'Success', 'Payment configuration saved successfully');
            closeAddPaymentModal();

            // Reload table
            // filterPayments();
        }

        function deletePaymentConfig(id) {
            if (confirm('Are you sure you want to delete this payment configuration?')) {
                console.log('Deleting payment config:', id);
                showToast('success', 'Deleted', 'Payment configuration deleted successfully');
                // TODO: Call API and reload table
            }
        }

        function filterPayments() {
            const program = document.getElementById('filter_program').value;
            const step = document.getElementById('filter_step').value;
            const status = document.getElementById('filter_status').value;

            console.log('Filtering payments:', { program, step, status });
            // TODO: Filter table rows or reload from API
        }

        function showToast(type, title, message) {
            const toast = document.getElementById('toast_notification');
            const content = document.getElementById('toast_content');
            const icon = document.getElementById('toast_icon');

            // Set colors based on type
            if (type === 'success') {
                content.classList.remove('border-red-500');
                content.classList.add('border-green-500');
                icon.classList.remove('text-red-500');
                icon.classList.add('text-green-500');
            } else {
                content.classList.remove('border-green-500');
                content.classList.add('border-red-500');
                icon.classList.remove('text-green-500');
                icon.classList.add('text-red-500');
            }

            document.getElementById('toast_title').textContent = title;
            document.getElementById('toast_message').textContent = message;
            toast.classList.remove('hidden');
            lucide.createIcons();

            // Auto hide after 3 seconds
            setTimeout(() => closeToast(), 3000);
        }

        function closeToast() {
            document.getElementById('toast_notification').classList.add('hidden');
        }

        // Payment Order Management Functions
        function openAddPaymentOrderModal() {
            document.getElementById('add_payment_order_modal').classList.remove('hidden');
            document.getElementById('payment_order_modal_title').textContent = 'Add Payment Order';
            document.getElementById('payment_order_form').reset();
            lucide.createIcons();
        }

        function closeAddPaymentOrderModal() {
            document.getElementById('add_payment_order_modal').classList.add('hidden');
        }

        function editPaymentOrder(id) {
            document.getElementById('add_payment_order_modal').classList.remove('hidden');
            document.getElementById('payment_order_modal_title').textContent = 'Edit Payment Order';
            // TODO: Load existing data
            // Example: const order = getPaymentOrderById(id);
            // document.getElementById('order_number').value = order.number;
            // document.getElementById('order_display_name').value = order.name;
            // document.getElementById('order_description').value = order.description;
            // document.getElementById('order_status').checked = order.status === 'active';
            lucide.createIcons();
        }

        function savePaymentOrder() {
            const form = document.getElementById('payment_order_form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                order_number: document.getElementById('order_number').value,
                display_name: document.getElementById('order_display_name').value,
                description: document.getElementById('order_description').value,
                status: document.getElementById('order_status').checked ? 'active' : 'inactive'
            };

            console.log('Saving payment order:', data);

            // TODO: Send to backend API
            // Example: fetch('/api/payment-orders', { method: 'POST', body: JSON.stringify(data) })

            showToast('success', 'Success', 'Payment order saved successfully');
            closeAddPaymentOrderModal();

            // TODO: Reload payment orders table
            // loadPaymentOrders();
        }

        function deletePaymentOrder(id) {
            if (confirm('Are you sure you want to delete this payment order? This may affect existing payment configurations.')) {
                console.log('Deleting payment order:', id);
                showToast('success', 'Deleted', 'Payment order deleted successfully');
                // TODO: Call API and reload table
            }
        }

        // ===== Tab Switching =====
        function switchPaymentTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.payment-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active styling from all buttons
            document.querySelectorAll('.payment-tab-button').forEach(btn => {
                btn.classList.remove('border-red-500');
                btn.classList.add('border-transparent', 'text-gray-500');
                btn.style.color = '';
                btn.style.borderColor = '';
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.remove('hidden');

            // Add active styling to clicked button
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-red-500');
            activeBtn.style.color = '#d82128';
            activeBtn.style.borderColor = '#d82128';

            // Refresh icons
            lucide.createIcons();
        }

        // ===== Commission Management Functions =====
        const programData = {
            'SP1A': { name: 'EF Scholarship Guarantee', defaultType: 'percentage' },
            'SP2': { name: 'Elite Admission', defaultType: 'percentage' },
            'SP3A': { name: 'Ivy Global - Package A', defaultType: 'fixed' },
            'SP3B': { name: 'Ivy Global - Package B', defaultType: 'fixed' },
            'SP3C': { name: 'Ivy Global - Package C', defaultType: 'fixed' }
        };

        function openAddCommissionModal() {
            document.getElementById('add_commission_modal').classList.remove('hidden');
            document.getElementById('commission_modal_title').textContent = 'Add Commission Configuration';
            document.getElementById('commission_form').reset();
            document.getElementById('commission_program_name').value = '';
            lucide.createIcons();
        }

        function closeAddCommissionModal() {
            document.getElementById('add_commission_modal').classList.add('hidden');
        }

        function editCommission(id) {
            document.getElementById('add_commission_modal').classList.remove('hidden');
            document.getElementById('commission_modal_title').textContent = 'Edit Commission Configuration';
            // TODO: Load existing data
            // Example data loading:
            // const commission = getCommissionById(id);
            // document.getElementById('commission_program_code').value = commission.code;
            // Auto-trigger program change to fill name
            // handleProgramCodeChange();
            lucide.createIcons();
        }

        function deleteCommission(id) {
            if (confirm('Are you sure you want to delete this commission configuration?')) {
                console.log('Deleting commission:', id);
                showToast('success', 'Deleted', 'Commission configuration deleted successfully');
                // TODO: Call API and reload table
            }
        }

        // Toggle parent agent details row
        function toggleParentDetails(rowId) {
            const detailsRow = document.getElementById(`parent_details_${rowId}`);
            const expandBtn = document.getElementById(`expand_btn_${rowId}`);
            const icon = expandBtn.querySelector('i');

            if (detailsRow.classList.contains('hidden')) {
                // Expand
                detailsRow.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'chevron-down');
                expandBtn.classList.add('rotate-90');
            } else {
                // Collapse
                detailsRow.classList.add('hidden');
                icon.setAttribute('data-lucide', 'chevron-right');
                expandBtn.classList.remove('rotate-90');
            }

            // Refresh lucide icons
            lucide.createIcons();
        }

        // Agent hierarchy definition
        const agentHierarchy = {
            'LA': ['L1', 'L2'],  // LA has 2 parent agents
            'L1': ['L2'],        // L1 has 1 parent agent
            'L2': []             // L2 has no parent agents
        };

        function toggleCommissionTypeInput(type) {
            const percentageOption = document.getElementById('percentage_commission_option');
            const fixedOption = document.getElementById('fixed_commission_option');
            const laPrefix = document.getElementById('la_prefix');
            const l1Prefix = document.getElementById('l1_prefix');
            const l2Prefix = document.getElementById('l2_prefix');

            if (type === 'percentage') {
                percentageOption.classList.add('border-red-500', 'bg-red-50');
                fixedOption.classList.remove('border-red-500', 'bg-red-50');
                laPrefix.textContent = '%';
                l1Prefix.textContent = '%';
                l2Prefix.textContent = '%';

                // Set max to 100 for percentage
                document.getElementById('commission_la').max = '100';
                document.getElementById('commission_l1').max = '100';
                document.getElementById('commission_l2').max = '100';
            } else {
                fixedOption.classList.add('border-red-500', 'bg-red-50');
                percentageOption.classList.remove('border-red-500', 'bg-red-50');
                laPrefix.textContent = '$';
                l1Prefix.textContent = '$';
                l2Prefix.textContent = '$';

                // Remove max for fixed amount
                document.getElementById('commission_la').removeAttribute('max');
                document.getElementById('commission_l1').removeAttribute('max');
                document.getElementById('commission_l2').removeAttribute('max');
            }

            // Update parent agent prefixes if they exist
            updateParentAgentPrefixes(type);
            lucide.createIcons();
        }

        function updateParentAgentPrefixes(type) {
            const prefix = type === 'percentage' ? '%' : '$';
            const maxValue = type === 'percentage' ? '100' : '';

            // Update all parent agent input prefixes
            document.querySelectorAll('[id^="parent_prefix_"]').forEach(el => {
                el.textContent = prefix;
            });

            // Update max attributes
            document.querySelectorAll('[id^="parent_commission_"]').forEach(input => {
                if (type === 'percentage') {
                    input.max = maxValue;
                } else {
                    input.removeAttribute('max');
                }
            });
        }

        // Render parent agent sections based on selected agent level
        function renderParentAgentSections() {
            const agentLevel = document.getElementById('commission_agent_level').value;
            const container = document.getElementById('parent_agents_container');

            // Clear existing parent sections
            container.innerHTML = '';

            if (!agentLevel) {
                return;
            }

            const parents = agentHierarchy[agentLevel];
            if (!parents || parents.length === 0) {
                return;
            }

            // Get current commission type to set correct prefix
            const commissionType = document.querySelector('input[name="commission_type"]:checked');
            const prefix = commissionType && commissionType.value === 'percentage' ? '%' : '$';
            const maxAttr = commissionType && commissionType.value === 'percentage' ? 'max="100"' : '';

            // Render each parent agent section
            parents.forEach((parentLevel, index) => {
                const section = document.createElement('div');
                section.className = 'border-t pt-4 mt-4';
                section.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center gap-2">
                            <i data-lucide="arrow-up-right" class="w-4 h-4 text-red-600"></i>
                            Parent Agent ${index + 1}: ${parentLevel}
                            <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${parentLevel === 'L1' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'
                    }">${parentLevel}</span>
                        </h4>
                        <p class="text-xs text-gray-600 mb-3">
                            This agent automatically receives commission when ${agentLevel} completes a sale
                        </p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Commission Value <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-500 text-sm" id="parent_prefix_${parentLevel.toLowerCase()}">${prefix}</span>
                                    <input
                                        type="number"
                                        id="parent_commission_${parentLevel.toLowerCase()}"
                                        required
                                        min="0"
                                        ${maxAttr}
                                        step="0.01"
                                        class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Notes (Optional)
                                </label>
                                <input
                                    type="text"
                                    id="parent_notes_${parentLevel.toLowerCase()}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    placeholder="Additional info..."
                                />
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(section);
            });

            lucide.createIcons();
        }

        // Auto-fill program name when program code is selected
        document.addEventListener('DOMContentLoaded', function () {
            const programCodeSelect = document.getElementById('commission_program_code');
            if (programCodeSelect) {
                programCodeSelect.addEventListener('change', function () {
                    const code = this.value;
                    const programNameInput = document.getElementById('commission_program_name');

                    if (code && programData[code]) {
                        programNameInput.value = programData[code].name;

                        // Auto-select commission type based on program
                        const defaultType = programData[code].defaultType;
                        const radioButton = document.querySelector(`input[name="commission_type"][value="${defaultType}"]`);
                        if (radioButton) {
                            radioButton.checked = true;
                            toggleCommissionTypeInput(defaultType);
                        }
                    } else {
                        programNameInput.value = '';
                    }
                });
            }
        });

        function saveCommission() {
            const form = document.getElementById('commission_form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const agentLevel = document.getElementById('commission_agent_level').value;
            if (!agentLevel) {
                alert('Please select an agent level');
                return;
            }

            const commissionType = document.querySelector('input[name="commission_type"]:checked');
            if (!commissionType) {
                alert('Please select a commission type (Percentage or Fixed Amount)');
                return;
            }

            // Collect parent agents data
            const parents = [];
            const parentLevels = agentHierarchy[agentLevel];

            if (parentLevels && parentLevels.length > 0) {
                for (const level of parentLevels) {
                    const valueInput = document.getElementById(`parent_commission_${level.toLowerCase()}`);
                    if (!valueInput || !valueInput.value) {
                        alert(`Please fill in commission value for parent agent ${level}`);
                        return;
                    }

                    parents.push({
                        level: level,
                        commissionType: commissionType.value,
                        value: parseFloat(valueInput.value),
                        notes: document.getElementById(`parent_notes_${level.toLowerCase()}`)?.value || ''
                    });
                }
            }

            const data = {
                program_code: document.getElementById('commission_program_code').value,
                program_name: document.getElementById('commission_program_name').value,
                agent: agentLevel,
                commission_type: commissionType.value,
                la: parseFloat(document.getElementById('commission_la').value),
                l1: parseFloat(document.getElementById('commission_l1').value),
                l2: parseFloat(document.getElementById('commission_l2').value),
                parents: parents
            };

            console.log('=== Commission Configuration ===');
            console.log(JSON.stringify(data, null, 2));

            // TODO: Send to backend API
            // Example: fetch('/api/commissions', { method: 'POST', body: JSON.stringify(data) })

            showToast('success', 'Success', `Commission configuration for ${agentLevel} saved successfully`);
            closeAddCommissionModal();

            // TODO: Reload commission table
            // loadCommissions();
        }

        // Legacy functions (keep for compatibility)
        function loadPaymentConfig() {
            // Deprecated - keeping for backwards compatibility
            console.log('loadPaymentConfig called - this function is deprecated');
        }

        function toggleFirstPaymentType(type) {
            // Deprecated
        }

        function toggleSecondPaymentType(type) {
            // Deprecated
        }

        function toggleThirdPaymentType(type) {
            // Deprecated
        }

        function resetPaymentConfig() {
            // Deprecated
        }

        function savePaymentConfig() {
            // Deprecated
        }

        function getPaymentConfig(programType) {
            // Deprecated
            return {};
        }
    </script>

    <!-- AI Assistant Floating Button -->
    <div id="ai-assistant" class="fixed bottom-6 right-6" style="z-index: 10000;">
        <button id="ai-toggle"
            class="w-14 h-14 rounded-full text-white shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center"
            style="background-color: #d82128;">
            <i data-lucide="message-circle" class="w-6 h-6"></i>
        </button>

        <!-- AI Chat Panel -->
        <div id="ai-chat-panel"
            class="hidden absolute bottom-16 right-0 w-80 h-96 bg-white rounded-lg shadow-xl border border-gray-200">
            <!-- Chat Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200"
                style="background-color: #d82128;">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center mr-3">
                        <i data-lucide="bot" class="w-4 h-4" style="color: #d82128;"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-white">AI Assistant</h3>
                        <p class="text-xs text-red-100">Online</p>
                    </div>
                </div>
                <button id="ai-close" class="text-white hover:text-red-100">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 p-4 h-64 overflow-y-auto">
                <div class="mb-4">
                    <div class="flex items-start">
                        <div class="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center mr-2 mt-1">
                            <i data-lucide="bot" class="w-3 h-3" style="color: #d82128;"></i>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                            <p class="text-sm text-gray-800">Hello! I can help you with payment processing, commission
                                calculations, and financial reporting. What would you like to know?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center">
                    <input type="text" id="chat-input" placeholder="Ask about payments..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    <button id="send-message" class="ml-2 p-2 rounded-lg text-white" style="background-color: #d82128;">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CREATE INVOICE MODAL LOGIC =====
        let currentInvoiceStep = 1;
        const invoiceData = {
            student: null,
            application: null,
            paymentStage: null,
            totalAmount: 0,
            dueDate: null,
            paymentMethod: 'bank_transfer',
            breakdown: {
                applyLead: 0,
                commission: 0,
                scholarship: 0
            }
        };

        // Sample data for demo
        const studentApplications = {
            'STU001': [
                { id: 'APP001', program: 'P1A', university: 'Harvard University' },
                { id: 'APP002', program: 'P2', university: 'Stanford University' }
            ],
            'STU002': [
                { id: 'APP003', program: 'P1B', universities: ['Angelo State University', 'Butler University', 'Ohio Northern University', 'Schiller International University'] }
            ],
            'STU003': [
                { id: 'APP004', program: 'P3A', university: 'Yale University' }
            ],
            'STU004': [
                { id: 'APP005', program: 'P2', university: 'Princeton University' }
            ]
        };

        const programNames = {
            'P1A': 'EF Scholarship Guarantee (1 University)',
            'P1B': 'EF Scholarship Guarantee (3–5 Universities)',
            'P2': 'Elite Admission Program',
            'P3A': 'Ivy Global Standard',
            'P3B': 'Ivy Global VIP Career',
            'P3C': 'Ivy Global President'
        };

        // Payment configuration rules (example)
        const paymentRules = {
            'P1A': { applyLeadPercent: 30, commissionPercent: 10, scholarshipPercent: 60 },
            'P1B': { applyLeadPercent: 35, commissionPercent: 15, scholarshipPercent: 50 },
            'P2': { applyLeadPercent: 40, commissionPercent: 12, scholarshipPercent: 48 },
            'P3A': { applyLeadPercent: 45, commissionPercent: 20, scholarshipPercent: 35 },
            'P3B': { applyLeadPercent: 50, commissionPercent: 25, scholarshipPercent: 25 },
            'P3C': { applyLeadPercent: 55, commissionPercent: 30, scholarshipPercent: 15 }
        };

        // Normalize currency-like input (accepts $ 200, 200,00, 200.00)
        function parseCurrency(v) {
            if (typeof v === 'number') return v;
            if (!v) return NaN;
            let s = String(v).trim();
            // remove currency symbols and spaces
            s = s.replace(/[^0-9,\.]/g, '');
            // if there is a comma but no dot, treat comma as decimal
            if (s.indexOf(',') > -1 && s.indexOf('.') === -1) {
                s = s.replace(',', '.');
            } else {
                // otherwise remove thousands separators
                s = s.replace(/,/g, '');
            }
            const n = parseFloat(s);
            return isNaN(n) ? NaN : n;
        }

        function openCreateInvoiceModal() {
            document.getElementById('create_invoice_modal').classList.remove('hidden');
            currentInvoiceStep = 1;
            updateInvoiceStepUI();
            lucide.createIcons();
        }

        function closeCreateInvoiceModal() {
            document.getElementById('create_invoice_modal').classList.add('hidden');
            resetInvoiceForm();
        }

        function resetInvoiceForm() {
            currentInvoiceStep = 1;
            document.getElementById('invoice_student').value = '';
            // Reset application multi-select UI
            selectedApplications = [];
            const optionsList = document.getElementById('application_options_list');
            const dropdownLabel = document.getElementById('application_dropdown_label');
            const dropdownMenu = document.getElementById('application_dropdown_menu');
            const detailsContainer = document.getElementById('application_details_container');
            const detailsList = document.getElementById('application_details_list');
            if (optionsList) optionsList.innerHTML = '<p class="px-3 py-2 text-sm text-gray-500">Select a student first</p>';
            if (dropdownLabel) {
                dropdownLabel.textContent = 'Select student first...';
                dropdownLabel.classList.remove('text-gray-900', 'text-gray-700');
                dropdownLabel.classList.add('text-gray-500');
            }
            if (dropdownMenu) dropdownMenu.classList.add('hidden');
            if (detailsContainer) detailsContainer.classList.add('hidden');
            if (detailsList) detailsList.innerHTML = '';
            document.getElementById('invoice_payment_stage').value = '';
            document.getElementById('invoice_total_amount').value = '';
            document.getElementById('invoice_due_date').value = '';
            invoiceData.student = null;
            invoiceData.applications = [];
            invoiceData.application = null;
            if (invoiceData.breakdown) invoiceData.breakdown.commission = 0;
        }

        function nextInvoiceStep() {
            // Sync current step with DOM visibility in case of out-of-sync state
            try {
                for (let i = 1; i <= 4; i++) {
                    const el = document.getElementById(`invoice_step_${i}`);
                    if (el && !el.classList.contains('hidden')) {
                        currentInvoiceStep = i;
                        break;
                    }
                }
            } catch (e) { /* no-op */ }
            // helpers to show inline validation
            const clearError = (el) => el && el.classList.remove('ring-2', 'ring-red-500', 'border-red-500');
            const setError = (el) => el && el.classList.add('ring-2', 'ring-red-500', 'border-red-500');

            // Validate current step
            if (currentInvoiceStep === 1) {
                const studentEl = document.getElementById('invoice_student');
                const appBtn = document.getElementById('application_dropdown_btn');
                const student = studentEl ? studentEl.value : '';
                clearError(studentEl);
                clearError(appBtn);
                let hasError = false;
                if (!student) { setError(studentEl); hasError = true; }
                if (!Array.isArray(selectedApplications) || selectedApplications.length === 0) {
                    setError(appBtn);
                    hasError = true;
                }
                if (hasError) {
                    alert('Please select student and at least one application');
                    return;
                }
            } else if (currentInvoiceStep === 2) {
                // Validate all per-application sections
                let hasError = false;
                const apps = Array.isArray(selectedApplications) ? selectedApplications : [];
                let total = 0;
                apps.forEach(app => {
                    const idSafe = String(app.id).replace(/[^\w-]/g, '_');
                    const stageEl = document.getElementById(`pay_stage_${idSafe}`);
                    const amountEl = document.getElementById(`pay_amount_${idSafe}`);
                    const dueEl = document.getElementById(`pay_due_${idSafe}`);
                    const commissionEnableEl = document.getElementById(`pay_commission_enable_${idSafe}`);
                    const commissionTypeEl = document.getElementById(`pay_commission_type_${idSafe}`);
                    const commissionValueEl = document.getElementById(`pay_commission_value_${idSafe}`);
                    [stageEl, amountEl, dueEl, commissionEnableEl, commissionTypeEl, commissionValueEl].forEach(clearError);
                    const stage = stageEl ? stageEl.value : '';
                    const amountStr = amountEl ? amountEl.value : '';
                    const amountVal = parseCurrency(amountStr);
                    if (!stage) { setError(stageEl); hasError = true; }
                    if (amountStr === '' || isNaN(amountVal) || amountVal <= 0) { setError(amountEl); hasError = true; }
                    if (!isNaN(amountVal)) total += Math.max(0, amountVal);

                    // Commission per application: enabled -> validate type/value
                    const enabled = commissionEnableEl && commissionEnableEl.checked;
                    if (enabled) {
                        const type = commissionTypeEl ? commissionTypeEl.value : 'fixed';
                        const valueRaw = commissionValueEl ? commissionValueEl.value : '';
                        const valueNum = parseCurrency(valueRaw);
                        if (valueRaw === '' || isNaN(valueNum) || valueNum < 0) {
                            setError(commissionValueEl); hasError = true;
                        } else if (type === 'percentage') {
                            if (valueNum > 100) { setError(commissionValueEl); hasError = true; alert('Commission percentage cannot exceed 100%.'); }
                        } else if (type === 'fixed') {
                            if (!isNaN(amountVal) && valueNum > Math.max(0, amountVal)) { setError(commissionValueEl); hasError = true; alert('Commission cannot exceed Amount for an application.'); }
                        }

                        // Validate commission distribution
                        let totalCommission = 0;
                        if (type === 'percentage') {
                            totalCommission = (amountVal * valueNum) / 100;
                        } else {
                            totalCommission = valueNum;
                        }

                        const personRows = document.querySelectorAll(`[data-person-of="${idSafe}"]`);
                        let totalPrimaryPct = 0;
                        let totalDistributedAmt = 0;
                        const primaryAmounts = {};

                        personRows.forEach(row => {
                            const isPrimary = row.getAttribute('data-primary') === 'true';
                            const role = row.getAttribute('data-role');
                            const pid = row.id.replace(`pay_person_row_${idSafe}_`, '');
                            const pctInput = document.getElementById(`pay_person_pct_${idSafe}_${pid}`);
                            const pct = pctInput ? (parseFloat(pctInput.value) || 0) : 0;

                            let calculatedAmount = 0;
                            if (isPrimary) {
                                calculatedAmount = (totalCommission * pct) / 100;
                                primaryAmounts[role] = calculatedAmount;
                                totalPrimaryPct += pct;
                            } else {
                                const primaryAmount = primaryAmounts[role] || 0;
                                calculatedAmount = (primaryAmount * pct) / 100;
                            }
                            totalDistributedAmt += calculatedAmount;
                        });

                        if (totalPrimaryPct > 100) {
                            alert(`Application ${app.id}: Total primary commission percentage (${totalPrimaryPct.toFixed(1)}%) exceeds 100%. Please adjust.`);
                            hasError = true;
                        }
                        if (totalDistributedAmt > totalCommission + 0.01) {
                            alert(`Application ${app.id}: Total distributed commission ($${totalDistributedAmt.toFixed(2)}) exceeds available commission ($${totalCommission.toFixed(2)}). Please adjust.`);
                            hasError = true;
                        }
                    }
                });

                if (hasError) {
                    alert('Please complete valid payment details for each application (stage and amount > 0).');
                    return;
                }

                // Persist collected data into invoiceData
                invoiceData.items = apps.map(app => {
                    const idSafe = String(app.id).replace(/[^\w-]/g, '_');
                    const stage = (document.getElementById(`pay_stage_${idSafe}`)?.value) || '';
                    const amount = parseCurrency(document.getElementById(`pay_amount_${idSafe}`)?.value || '');
                    const due = (document.getElementById(`pay_due_${idSafe}`)?.value) || '';
                    const commissionEnabled = !!document.getElementById(`pay_commission_enable_${idSafe}`)?.checked;
                    const commissionType = document.getElementById(`pay_commission_type_${idSafe}`)?.value || 'fixed';
                    const commissionValue = parseCurrency(document.getElementById(`pay_commission_value_${idSafe}`)?.value || '');
                    let commissionComputed = 0;
                    if (commissionEnabled && !isNaN(commissionValue) && commissionValue >= 0) {
                        if (commissionType === 'percentage') {
                            commissionComputed = (isNaN(amount) ? 0 : amount) * (commissionValue / 100);
                        } else {
                            commissionComputed = commissionValue;
                        }
                    }
                    return { appId: app.id, program: app.program, serviceName: app.serviceName || '', universities: app.universities, stage, amount, due, commissionEnabled, commissionType, commissionValue, commission: commissionComputed };
                });
                invoiceData.totalAmount = total;
                // choose preview due date as earliest among provided ones, or null
                const dueDates = invoiceData.items.map(it => it.due).filter(Boolean).map(d => new Date(d));
                invoiceData.dueDate = dueDates.length ? new Date(Math.min.apply(null, dueDates)).toISOString() : null;
                invoiceData.paymentStage = null; // multiple stages
                // Sum of commissions across items
                invoiceData.breakdown.commission = invoiceData.items.reduce((s, it) => s + (isNaN(it.commission) ? 0 : Math.max(0, it.commission)), 0);

                // Generate preview with multiple items
                generateInvoicePreview();
            } else if (currentInvoiceStep === 3) {
                // Create invoice
                createInvoice();
                return;
            }

            currentInvoiceStep++;
            if (currentInvoiceStep > 3) currentInvoiceStep = 3;
            console.debug('[Invoice] Advancing to step', currentInvoiceStep);
            updateInvoiceStepUI();
            // Fallback: if for any reason the target step remains hidden, force toggle visibility
            setTimeout(() => {
                const target = document.getElementById(`invoice_step_${currentInvoiceStep}`);
                if (target && target.classList.contains('hidden')) {
                    console.warn('[Invoice] Fallback applied: forcibly showing step', currentInvoiceStep);
                    for (let i = 1; i <= 3; i++) {
                        const el = document.getElementById(`invoice_step_${i}`);
                        if (!el) continue;
                        if (i === currentInvoiceStep) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                }
            }, 0);
        }

        function previousInvoiceStep() {
            currentInvoiceStep--;
            if (currentInvoiceStep < 1) currentInvoiceStep = 1;
            updateInvoiceStepUI();
        }

        function updateInvoiceStepUI() {
            // Hide all steps
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`invoice_step_${i}`).classList.add('hidden');
                const indicator = document.getElementById(`step_indicator_${i}`);
                if (i < currentInvoiceStep) {
                    indicator.classList.remove('opacity-50');
                    const dot = indicator.querySelector('div');
                    // Past steps: white background with red text (no green)
                    dot.classList.remove('bg-red-400', 'bg-green-500', 'text-white');
                    dot.classList.add('bg-white', 'text-red-600');
                } else if (i === currentInvoiceStep) {
                    indicator.classList.remove('opacity-50');
                    const dot = indicator.querySelector('div');
                    dot.classList.remove('bg-red-400', 'bg-green-500', 'text-white');
                    dot.classList.add('bg-white', 'text-red-600');
                } else {
                    indicator.classList.add('opacity-50');
                    const dot = indicator.querySelector('div');
                    dot.classList.remove('bg-white', 'bg-green-500', 'text-red-600');
                    dot.classList.add('bg-red-400', 'text-white');
                }
            }

            // Show current step
            document.getElementById(`invoice_step_${currentInvoiceStep}`).classList.remove('hidden');

            // When entering Step 2, render payment sections based on selected applications
            if (currentInvoiceStep === 2) {
                renderApplicationPaymentsSections();
            }

            // Update buttons
            const btnPrevious = document.getElementById('btn_previous');
            const btnNext = document.getElementById('btn_next');

            if (currentInvoiceStep === 1) {
                btnPrevious.classList.add('hidden');
            } else {
                btnPrevious.classList.remove('hidden');
            }

            if (currentInvoiceStep === 3) {
                btnNext.innerHTML = '<i data-lucide="send" class="w-4 h-4 inline mr-1"></i> Create & Send Invoice';
            } else {
                btnNext.innerHTML = 'Next Step <i data-lucide="arrow-right" class="w-4 h-4 inline ml-1"></i>';
            }

            lucide.createIcons();
        }

        // Removed global commission toggle; commission is now per-application.

        // Track selected applications
        let selectedApplications = [];

        function loadStudentApplications(studentId) {
            invoiceData.student = studentId;
            selectedApplications = [];

            const optionsList = document.getElementById('application_options_list');
            const dropdownLabel = document.getElementById('application_dropdown_label');

            if (studentApplications[studentId] && studentApplications[studentId].length > 0) {
                const appOptions = studentApplications[studentId].map(app => {
                    const uniLabel = app.universities ? `${app.universities.length} universities` : app.university;
                    return `
                        <label class="flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" 
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500" 
                                   value="${app.id}"
                                   data-program="${app.program}"
                                   data-universities='${JSON.stringify(app.universities ? app.universities : [app.university])}'
                                   onchange="handleApplicationSelection()">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900">${app.id}</div>
                                <div class="text-xs text-gray-500">${programNames[app.program]} (${uniLabel})</div>
                            </div>
                        </label>
                    `;
                }).join('');
                // Static services list
                const services = [
                    { id: 'SVC_VISA_PREP', name: 'Visa Preparation' },
                    { id: 'SVC_HEALTH_INS', name: 'Health Insurance' },
                    { id: 'SVC_APP_REVIEW', name: 'Application Review' },
                    { id: 'SVC_INTERVIEW', name: 'Interview Coaching' }
                ];
                const serviceOptions = `
                    <div class="px-3 pt-2 pb-1 text-[11px] uppercase tracking-wide text-gray-500">Services</div>
                    ${services.map(s => `
                        <label class="flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" 
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500" 
                                   value="${s.id}"
                                   data-program="SERVICE"
                                   data-service-name="${s.name}"
                                   data-universities='[]'
                                   onchange="handleApplicationSelection()">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900">${s.name}</div>
                                <div class="text-xs text-gray-500">Service</div>
                            </div>
                        </label>
                    `).join('')}
                `;
                optionsList.innerHTML = appOptions + serviceOptions;
                dropdownLabel.textContent = 'Select applications & services...';
                dropdownLabel.classList.remove('text-gray-500');
                dropdownLabel.classList.add('text-gray-700');
            } else {
                optionsList.innerHTML = '<p class="px-3 py-2 text-sm text-gray-500">No applications available</p>';
                dropdownLabel.textContent = 'No applications available';
            }

            document.getElementById('application_details_container').classList.add('hidden');
            renderApplicationDetails();
            lucide.createIcons();
        }

        function toggleApplicationDropdown() {
            const menu = document.getElementById('application_dropdown_menu');
            menu.classList.toggle('hidden');
        }

        function handleApplicationSelection() {
            const checkboxes = document.querySelectorAll('#application_options_list input[type="checkbox"]');
            selectedApplications = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => ({
                    id: cb.value,
                    program: cb.dataset.program,
                    universities: JSON.parse(cb.dataset.universities || '[]'),
                    serviceName: cb.dataset.serviceName || ''
                }));

            updateDropdownLabel();
            renderApplicationDetails();
        }

        function updateDropdownLabel() {
            const label = document.getElementById('application_dropdown_label');
            const count = selectedApplications.length;

            if (count === 0) {
                label.textContent = 'Select applications & services...';
                label.classList.remove('text-gray-900');
                label.classList.add('text-gray-500');
            } else if (count === 1) {
                const one = selectedApplications[0];
                if (one.program === 'SERVICE') {
                    label.textContent = one.serviceName || 'Service';
                } else {
                    label.textContent = `${one.id} - ${programNames[one.program]}`;
                }
                label.classList.remove('text-gray-500');
                label.classList.add('text-gray-900');
            } else {
                label.textContent = `${count} items selected`;
                label.classList.remove('text-gray-500');
                label.classList.add('text-gray-900');
            }
        }

        function renderApplicationDetails() {
            const container = document.getElementById('application_details_container');
            const list = document.getElementById('application_details_list');

            if (selectedApplications.length === 0) {
                container.classList.add('hidden');
                invoiceData.applications = [];
                invoiceData.application = null;
                return;
            }

            // Update invoice data
            invoiceData.applications = selectedApplications;
            invoiceData.application = selectedApplications[0]; // Keep first for backward compatibility

            // Render one card per application or service
            list.innerHTML = selectedApplications.map(app => `
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Application ID</p>
                            <p class="text-sm font-semibold text-gray-900">${app.id}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">${app.program === 'SERVICE' ? 'Service' : 'Program Type'}</p>
                            <p class="text-sm font-semibold text-gray-900">${app.program === 'SERVICE' ? (app.serviceName || 'Service') : `${app.program} - ${programNames[app.program]}`}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Universities</p>
                            ${app.program === 'SERVICE' ? `<span class="text-xs text-gray-500">N/A</span>` : `
                            <div class="flex flex-wrap gap-2">
                                ${app.universities.slice(0, 4).map(u => `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border">${u}</span>
                                `).join('')}
                                ${app.universities.length > 4 ? `<span class="text-xs text-gray-500">+${app.universities.length - 4} more</span>` : ''}
                            </div>`}
                        </div>
                    </div>
                </div>
            `).join('');

            container.classList.remove('hidden');
            lucide.createIcons();
        }

        // Render per-application payment sections for Step 2
        function renderApplicationPaymentsSections() {
            const wrap = document.getElementById('application_payments_container');
            if (!wrap) return;
            const apps = Array.isArray(selectedApplications) ? selectedApplications : [];
            if (apps.length === 0) { wrap.innerHTML = '<p class="text-sm text-gray-500">No applications selected.</p>'; return; }

            wrap.innerHTML = apps.map(app => {
                const idSafe = String(app.id).replace(/[^\w-]/g, '_');
                const uniLabel = (app.universities && app.universities.length)
                    ? `${app.universities.slice(0, 3).join(', ')}${app.universities.length > 3 ? ' +' + (app.universities.length - 3) + ' more' : ''}`
                    : '-';
                return `
                <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <p class="text-xs text-gray-500">Application</p>
                      <p class="text-sm font-semibold text-gray-900">${app.id} • ${app.program === 'SERVICE' ? (app.serviceName || 'Service') : (programNames[app.program] || app.program)}</p>
                      <p class="text-xs text-gray-500">${uniLabel}</p>
                    </div>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2"><i data-lucide="list" class="w-4 h-4 inline mr-1"></i> Payment Stage <span class="text-red-600">*</span></label>
                      <select id="pay_stage_${idSafe}" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" onchange="recalcInvoiceTotals()">
                        <option value="">Select payment stage...</option>
                        <option value="first">First Payment</option>
                        <option value="second">Second Payment</option>
                        <option value="third">Third Payment</option>
                        <option value="service_fee">Service Fee</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2"><i data-lucide="dollar-sign" class="w-4 h-4 inline mr-1"></i> Amount <span class="text-red-600">*</span></label>
                      <input id="pay_amount_${idSafe}" type="text" placeholder="0.00" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" oninput="recalcInvoiceTotals(); calcPersonCommission('${idSafe}')" />
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2"><i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> Due Date</label>
                      <input id="pay_due_${idSafe}" type="date" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" onchange="recalcInvoiceTotals()" />
                    </div>
                  </div>

                  <!-- Second row: Commission controls -->
                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex flex-wrap items-center gap-3">
                      <label class="inline-flex items-center gap-2 select-none">
                        <input id="pay_commission_enable_${idSafe}" type="checkbox" class="w-4 h-4 rounded" style="accent-color:#d82128;" onchange="toggleAppCommission('${idSafe}')" />
                        <span class="text-sm font-semibold text-gray-700"><i data-lucide="users" class="w-4 h-4 inline mr-1"></i> Include Commission</span>
                      </label>
                      <div id="pay_commission_wrap_${idSafe}" class="hidden flex items-center gap-2">
                        <div class="inline-flex border rounded-lg overflow-hidden" role="group" aria-label="Commission Type">
                          <button type="button" id="pay_commission_btn_fixed_${idSafe}" class="px-2.5 py-1.5 text-xs font-medium bg-red-600 text-white hover:bg-red-700" onclick="setAppCommissionType('${idSafe}','fixed')">$ Fixed</button>
                          <button type="button" id="pay_commission_btn_percent_${idSafe}" class="px-2.5 py-1.5 text-xs font-medium bg-white text-gray-700 hover:bg-gray-50 border-l" onclick="setAppCommissionType('${idSafe}','percentage')">% Percent</button>
                        </div>
                        <div class="relative w-28 md:w-36 flex-none">
                          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-semibold" id="pay_commission_symbol_${idSafe}">$</span>
                          <input type="hidden" id="pay_commission_type_${idSafe}" value="fixed" />
                          <input id="pay_commission_value_${idSafe}" type="number" min="0" step="0.01" placeholder="0.00" class="w-full pl-7 pr-2 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm" oninput="recalcInvoiceTotals(); calcPersonCommission('${idSafe}')" />
                        </div>
                        <span id="pay_commission_hint_${idSafe}" class="text-[11px] text-gray-500 whitespace-nowrap">Fixed ≤ Amount</span>
                      </div>

                      <!-- Agents & Advisors (only visible when commission is included) -->
                      <div id="people_block_${idSafe}" class="hidden basis-full mt-2">
                        <div class="flex items-center justify-between mb-2">
                          <h5 class="text-sm font-semibold text-gray-800 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Commission Distribution</h5>
                          <span class="text-xs text-gray-500">Primary: % of commission • Support: % of primary's amount</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2" id="people_list_${idSafe}">
                          ${(() => {
                        // Role definitions with deterministic per-application counts using seeded RNG
                        function hashStrCounts(str) {
                            let h = 2166136261 >>> 0;
                            for (let i = 0; i < str.length; i++) { h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
                            return h >>> 0;
                        }
                        function mulberry32Counts(a) {
                            return function () { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; };
                        }
                        function randInt(rng, min, max) { return Math.floor(rng() * (max - min + 1)) + min; }
                        const rngCounts = mulberry32Counts(hashStrCounts(String(app.id) + '|counts'));
                        const roleDefs = [
                            // Agent: always 1 primary, support 0–1
                            { key: 'Agent', label: 'Agent', shortLabel: 'AG', counts: [1, randInt(rngCounts, 0, 1)] },
                            // Academic Advisor: primary 1, support 0–2
                            { key: 'Academic Advisor', label: 'Academic Advisor', shortLabel: 'AA', counts: [1, randInt(rngCounts, 0, 2)] },
                            // Visa Advisor: primary 1, support 2–4 (around baseline 3)
                            { key: 'Visa Advisor', label: 'Visa Advisor', shortLabel: 'VA', counts: [1, randInt(rngCounts, 2, 4)] },
                            // Senior Advisor: primary 1, support 1–3 (around baseline 2)
                            { key: 'Senior Advisor', label: 'Senior Advisor', shortLabel: 'SA', counts: [1, randInt(rngCounts, 1, 3)] },
                        ];
                        // Create groups from app data if available; otherwise mock
                        const groups = {};
                        roleDefs.forEach(r => { groups[r.key] = []; });
                        if (Array.isArray(app.agents)) {
                            app.agents.forEach((a, idx) => groups['Agent'].push({ id: a.id || `AG_${idx + 1}`, name: a.name || a.email || `Agent ${idx + 1}`, primary: idx === 0 }));
                        }
                        if (Array.isArray(app.advisors)) {
                            app.advisors.forEach((a, idx) => {
                                const role = a.role && roleDefs.some(rd => rd.key === a.role) ? a.role : 'Academic Advisor';
                                const arr = groups[role] || (groups[role] = []);
                                arr.push({ id: a.id || `${role.replace(/\s/g, '_').toUpperCase()}_${idx + 1}`, name: a.name || a.email || `${role} ${idx + 1}` });
                            });
                        }
                        // Fill with mocks to meet counts, using randomized real-looking names per role
                        roleDefs.forEach(def => {
                            const [needPrimary, needSupport] = def.counts;
                            const list = groups[def.key] || (groups[def.key] = []);
                            // Simple name pools per role
                            const pools = {
                                'Agent': [
                                    'Alex Nguyen', 'Chris Tran', 'Minh Le', 'Huy Pham', 'Trung Do',
                                    'David Pham', 'Emily Do', 'Jason Vo', 'Sophia Le', 'Michael Nguyen',
                                    'Anthony Tran', 'Olivia Phan', 'Daniel Vu', 'Grace Bui', 'Ethan Ho'
                                ],
                                'Academic Advisor': [
                                    'Thao Phan', 'Lan Anh', 'Quynh Nguyen', 'Bao Chau', 'Kim Phuong',
                                    'Anna Nguyen', 'Daniel Phan', 'Sarah Tran', 'Kevin Le', 'Jenny Vo',
                                    'Henry Vu', 'Ava Pham', 'Noah Bui', 'Mia Ho', 'Lucas Dang'
                                ],
                                'Visa Advisor': [
                                    'Thanh Vu', 'Hoang Nguyen', 'Duc Anh', 'Pham Tuan', 'My Linh', 'Bich Phuong',
                                    'Robert Le', 'Isabella Tran', 'James Pham', 'Charlotte Nguyen', 'Benjamin Vo',
                                    'Amelia Do', 'Logan Bui', 'Harper Phan', 'Jacky Truong', 'Zoe Dang'
                                ],
                                'Senior Advisor': [
                                    'Anh Tuan', 'Ngoc Mai', 'Le Khoa', 'Thu Trang', 'Gia Han', 'Khanh Linh',
                                    'William Nguyen', 'Victoria Pham', 'Christopher Tran', 'Natalie Le', 'Andrew Vo',
                                    'Sophia Phan', 'Jonathan Vu', 'Chloe Do', 'Matthew Bui', 'Ella Ho'
                                ]
                            };
                            // Deterministic RNG seeded by app.id to keep names stable per application
                            function hashStr(str) {
                                let h = 2166136261 >>> 0;
                                for (let i = 0; i < str.length; i++) {
                                    h ^= str.charCodeAt(i);
                                    h = Math.imul(h, 16777619);
                                }
                                return h >>> 0;
                            }
                            function mulberry32(a) {
                                return function () {
                                    let t = a += 0x6D2B79F5;
                                    t = Math.imul(t ^ (t >>> 15), t | 1);
                                    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                                    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
                                };
                            }
                            const rng = mulberry32(hashStr(String(app.id) + '|' + def.key));
                            const used = new Set((list || []).map(p => p.name));
                            function nextName(role) {
                                const arr = pools[role] || pools['Agent'];
                                // pick a random unused name; if all used, append index
                                const available = arr.filter(n => !used.has(n));
                                const pickArr = available.length ? available : arr;
                                const name = pickArr[Math.floor(rng() * pickArr.length)];
                                used.add(name);
                                return name;
                            }
                            // Ensure primaries
                            while (list.filter(p => p.primary).length < needPrimary) {
                                const idx = list.length + 1;
                                const name = nextName(def.key);
                                list.push({ id: `${def.shortLabel}_P${idx}`, name, primary: true });
                            }
                            // Ensure supports
                            while (list.filter(p => !p.primary).length < needSupport) {
                                const idx = list.filter(p => !p.primary).length + 1;
                                const name = nextName(def.key);
                                list.push({ id: `${def.shortLabel}_S${idx}`, name, primary: false });
                            }
                        });
                        // Render 4 columns
                        return roleDefs.map(def => {
                            const list = groups[def.key];
                            const primaryPerson = list.find(p => p.primary);
                            const supportPeople = list.filter(p => !p.primary);
                            return `
                                <div class="border border-gray-200 rounded-lg shadow-sm">
                                  <div class="px-2 py-1.5 bg-gray-50 text-gray-800 rounded-t-lg text-center border-b border-gray-200">
                                    <p class="text-[11px] font-semibold">${def.label}</p>
                                  </div>
                                  <div class="p-2 space-y-1.5">
                                    ${primaryPerson ? `
                                      <div class="border-b pb-2" data-person-of="${idSafe}" data-role="${def.key}" data-primary="true" id="pay_person_row_${idSafe}_${String(primaryPerson.id).replace(/[^\w-]/g, '_')}">
                                        <div class="flex items-center justify-between mb-1">
                                          <p class="text-[11px] font-semibold text-gray-900 truncate">${primaryPerson.name}</p>
                                          <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800 font-medium">Primary</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                          <div class="relative w-24">
                                            <input id="pay_person_pct_${idSafe}_${String(primaryPerson.id).replace(/[^\w-]/g, '_')}" type="number" min="0" max="100" step="0.01" placeholder="0" class="w-full pr-7 pl-2 py-1 border border-gray-300 rounded text-[11px] font-mono text-right" oninput="calcPersonCommission('${idSafe}')" />
                                            <span class="absolute right-1.5 top-1/2 -translate-y-1/2 text-gray-500 text-[11px] font-semibold">%</span>
                                          </div>
                                          <span id="pay_person_amt_${idSafe}_${String(primaryPerson.id).replace(/[^\w-]/g, '_')}" class="text-[11px] font-medium text-gray-800 whitespace-nowrap ml-auto">$0.00</span>
                                        </div>
                                      </div>
                                    ` : ''}
                                    ${supportPeople.map(p => {
                                const pid = String(p.id).replace(/[^\w-]/g, '_');
                                return `
                                        <div class="" data-person-of="${idSafe}" data-role="${def.key}" data-primary="false" id="pay_person_row_${idSafe}_${pid}">
                                          <div class="flex items-center justify-between mb-1">
                                            <p class="text-[11px] text-gray-700 truncate">${p.name}</p>
                                            <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-gray-100 text-gray-600 font-medium">${def.key === 'Agent' ? 'Parent' : 'Support'}</span>
                                          </div>
                                          <div class="flex items-center gap-1.5">
                                            <div class="relative w-24">
                                              <input id="pay_person_pct_${idSafe}_${pid}" type="number" min="0" max="100" step="0.01" placeholder="0" class="w-full pr-7 pl-2 py-1 border border-gray-300 rounded text-[11px] font-mono text-right" oninput="calcPersonCommission('${idSafe}')" />
                                              <span class="absolute right-1.5 top-1/2 -translate-y-1/2 text-gray-500 text-[11px] font-semibold">%</span>
                                            </div>
                                            <span id="pay_person_amt_${idSafe}_${pid}" class="text-[11px] font-medium text-gray-800 whitespace-nowrap ml-auto">$0.00</span>
                                          </div>
                                        </div>
                                      `;
                            }).join('')}
                                  </div>
                                </div>
                              `;
                        }).join('');
                    })()}
                        </div>
                        <!-- Commission Distribution Summary -->
                        <div id="commission_summary_${idSafe}" class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                          <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                              <div>
                                <p class="text-xs text-gray-600">Total Primary %:</p>
                                <p id="total_primary_pct_${idSafe}" class="text-sm font-bold text-gray-900">0.0%</p>
                              </div>
                              <div>
                                <p class="text-xs text-gray-600">Total Distributed:</p>
                                <p id="total_distributed_amt_${idSafe}" class="text-sm font-bold text-gray-900">$0.00</p>
                              </div>
                              <div>
                                <p class="text-xs text-gray-600">Available Commission:</p>
                                <p id="available_commission_${idSafe}" class="text-sm font-bold" style="color:#d82128;">$0.00</p>
                              </div>
                            </div>
                            <div id="commission_warning_${idSafe}" class="hidden">
                              <div class="flex items-center gap-2 px-3 py-1.5 bg-red-50 border border-red-200 rounded-lg">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-red-600"></i>
                                <p class="text-xs font-medium text-red-600">Exceeded limit!</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;
            }).join('');

            if (window.lucide && lucide.createIcons) lucide.createIcons();
            recalcInvoiceTotals();
        }

        function recalcInvoiceTotals() {
            const apps = Array.isArray(selectedApplications) ? selectedApplications : [];
            let sum = 0;
            apps.forEach(app => {
                const idSafe = String(app.id).replace(/[^\w-]/g, '_');
                const amountEl = document.getElementById(`pay_amount_${idSafe}`);
                const val = amountEl ? parseCurrency(amountEl.value) : 0;
                if (!isNaN(val)) sum += val;

                // Update commission symbol based on type (for UX)
                const typeEl = document.getElementById(`pay_commission_type_${idSafe}`);
                const symEl = document.getElementById(`pay_commission_symbol_${idSafe}`);
                if (typeEl && symEl) {
                    symEl.textContent = (typeEl.value === 'percentage') ? '%' : '$';
                    // update constraints for current type
                    updateCommissionConstraints(idSafe);
                }
            });
            const sumEl = document.getElementById('invoice_total_amount_sum');
            if (sumEl) sumEl.textContent = `$${(sum || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            // store to invoiceData
            invoiceData.totalAmount = sum;
            return sum;
        }

        // Toggle commission controls per application
        function toggleAppCommission(idSafe) {
            const wrap = document.getElementById(`pay_commission_wrap_${idSafe}`);
            const peopleBlock = document.getElementById(`people_block_${idSafe}`);
            const enable = document.getElementById(`pay_commission_enable_${idSafe}`)?.checked;
            if (wrap) wrap.classList.toggle('hidden', !enable);
            if (peopleBlock) peopleBlock.classList.toggle('hidden', !enable);
            // Initialize the commission UI state when enabling
            if (enable) {
                const currentType = document.getElementById(`pay_commission_type_${idSafe}`)?.value || 'fixed';
                setAppCommissionType(idSafe, currentType);
                updateCommissionConstraints(idSafe);
            }
        }

        // Toggle commission type between fixed ($) and percentage (%)
        function toggleAppCommissionType(idSafe) {
            const typeEl = document.getElementById(`pay_commission_type_${idSafe}`);
            const symEl = document.getElementById(`pay_commission_symbol_${idSafe}`);
            if (!typeEl || !symEl) return;
            typeEl.value = (typeEl.value === 'fixed') ? 'percentage' : 'fixed';
            symEl.textContent = (typeEl.value === 'percentage') ? '%' : '$';
            updateCommissionConstraints(idSafe);
            recalcInvoiceTotals();
        }

        // Set commission type and update UI (buttons, symbol, hint)
        function setAppCommissionType(idSafe, type) {
            const typeEl = document.getElementById(`pay_commission_type_${idSafe}`);
            const symEl = document.getElementById(`pay_commission_symbol_${idSafe}`);
            const btnFixed = document.getElementById(`pay_commission_btn_fixed_${idSafe}`);
            const btnPercent = document.getElementById(`pay_commission_btn_percent_${idSafe}`);
            const hint = document.getElementById(`pay_commission_hint_${idSafe}`);
            if (!typeEl || !symEl || !btnFixed || !btnPercent) return;
            const normalized = (type === 'percentage') ? 'percentage' : 'fixed';
            typeEl.value = normalized;
            symEl.textContent = normalized === 'percentage' ? '%' : '$';
            updateCommissionConstraints(idSafe);
            // Update buttons
            if (normalized === 'fixed') {
                btnFixed.className = 'px-2.5 py-1.5 text-xs font-medium bg-red-600 text-white hover:bg-red-700';
                btnPercent.className = 'px-2.5 py-1.5 text-xs font-medium bg-white text-gray-700 hover:bg-gray-50 border-l';
                if (hint) hint.textContent = 'Fixed ≤ Amount';
            } else {
                btnPercent.className = 'px-2.5 py-1.5 text-xs font-medium bg-red-600 text-white hover:bg-red-700';
                btnFixed.className = 'px-2.5 py-1.5 text-xs font-medium bg-white text-gray-700 hover:bg-gray-50';
                if (hint) hint.textContent = '% in 0–100';
            }
            recalcInvoiceTotals();
        }

        // Apply constraints and placeholder according to commission type
        function updateCommissionConstraints(idSafe) {
            const type = document.getElementById(`pay_commission_type_${idSafe}`)?.value || 'fixed';
            const input = document.getElementById(`pay_commission_value_${idSafe}`);
            if (!input) return;
            input.min = '0';
            input.step = '0.01';
            if (type === 'percentage') {
                input.max = '100';
                input.placeholder = '0.00';
                input.setAttribute('aria-label', 'Commission percentage');
            } else {
                input.max = '100000';
                input.placeholder = '0.00';
                input.setAttribute('aria-label', 'Commission amount');
            }
        }

        // Calculate per-person commission based on percentages
        function calcPersonCommission(idSafe) {
            // Get app-level commission
            const amountEl = document.getElementById(`pay_amount_${idSafe}`);
            const commissionTypeEl = document.getElementById(`pay_commission_type_${idSafe}`);
            const commissionValueEl = document.getElementById(`pay_commission_value_${idSafe}`);

            const amount = amountEl ? parseCurrency(amountEl.value) : 0;
            const commissionType = commissionTypeEl ? commissionTypeEl.value : 'fixed';
            const commissionValue = commissionValueEl ? parseCurrency(commissionValueEl.value) : 0;

            let totalCommission = 0;
            if (commissionType === 'percentage') {
                totalCommission = (amount * commissionValue) / 100;
            } else {
                totalCommission = commissionValue;
            }

            // Find all person rows for this application
            const personRows = document.querySelectorAll(`[data-person-of="${idSafe}"]`);
            const primaryAmounts = {}; // Store primary amounts per role for support calculation
            let totalPrimaryPct = 0;
            let totalDistributedAmt = 0;

            personRows.forEach(row => {
                const isPrimary = row.getAttribute('data-primary') === 'true';
                const role = row.getAttribute('data-role');
                const rowId = row.id;
                const pid = rowId.replace(`pay_person_row_${idSafe}_`, '');

                const pctInput = document.getElementById(`pay_person_pct_${idSafe}_${pid}`);
                const amtSpan = document.getElementById(`pay_person_amt_${idSafe}_${pid}`);

                if (!pctInput || !amtSpan) return;

                const pct = parseFloat(pctInput.value) || 0;
                let calculatedAmount = 0;

                if (isPrimary) {
                    // Primary: % of total commission
                    calculatedAmount = (totalCommission * pct) / 100;
                    primaryAmounts[role] = calculatedAmount; // Store for support calculation
                    totalPrimaryPct += pct;
                } else {
                    // Support: % of primary's amount for this role
                    const primaryAmount = primaryAmounts[role] || 0;
                    calculatedAmount = (primaryAmount * pct) / 100;
                }

                totalDistributedAmt += calculatedAmount;
                amtSpan.textContent = `$${calculatedAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            });

            // Update summary display
            const totalPrimaryPctEl = document.getElementById(`total_primary_pct_${idSafe}`);
            const totalDistributedAmtEl = document.getElementById(`total_distributed_amt_${idSafe}`);
            const availableCommissionEl = document.getElementById(`available_commission_${idSafe}`);
            const warningEl = document.getElementById(`commission_warning_${idSafe}`);

            if (totalPrimaryPctEl) {
                totalPrimaryPctEl.textContent = `${totalPrimaryPct.toFixed(1)}%`;
                if (totalPrimaryPct > 100) {
                    totalPrimaryPctEl.classList.add('text-red-600');
                    totalPrimaryPctEl.classList.remove('text-gray-900');
                } else {
                    totalPrimaryPctEl.classList.remove('text-red-600');
                    totalPrimaryPctEl.classList.add('text-gray-900');
                }
            }

            if (totalDistributedAmtEl) {
                totalDistributedAmtEl.textContent = `$${totalDistributedAmt.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                if (totalDistributedAmt > totalCommission) {
                    totalDistributedAmtEl.classList.add('text-red-600');
                    totalDistributedAmtEl.classList.remove('text-gray-900');
                } else {
                    totalDistributedAmtEl.classList.remove('text-red-600');
                    totalDistributedAmtEl.classList.add('text-gray-900');
                }
            }

            const remainingCommission = totalCommission - totalDistributedAmt;
            if (availableCommissionEl) {
                availableCommissionEl.textContent = `$${remainingCommission.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }

            // Show/hide warning
            if (warningEl) {
                if (totalPrimaryPct > 100 || totalDistributedAmt > totalCommission) {
                    warningEl.classList.remove('hidden');
                    if (window.lucide) lucide.createIcons();
                } else {
                    warningEl.classList.add('hidden');
                }
            }
        }

        function loadPaymentConfig() {
            // This would load from the payment configuration
            // For now, just trigger recalculation if amount is already entered
            const amount = document.getElementById('invoice_total_amount').value;
            if (amount) {
                calculateBreakdown();
            }
        }

        // Build invoice preview (supports multiple applications)
        function generateInvoicePreview() {
            const studentSelect = document.getElementById('invoice_student');
            const studentText = studentSelect && studentSelect.selectedIndex >= 0
                ? studentSelect.options[studentSelect.selectedIndex].text
                : '-';
            const [name, email] = studentText.split(' - ');

            // Generic instruction since payment method step was removed
            const methodText = 'Payment method will be coordinated by ApplyLead. Please follow the instructions sent to your email after receiving this invoice.';

            // Generate invoice number and dates
            const invoiceNumber = `INV-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 9999)).padStart(4, '0')}`;
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Prepare items: prefer invoiceData.items (multi-app), else fallback to single application
            let items = Array.isArray(invoiceData.items) && invoiceData.items.length
                ? invoiceData.items
                : (invoiceData.application ? [{
                    appId: invoiceData.application.id,
                    program: invoiceData.application.program,
                    universities: invoiceData.application.universities || [],
                    stage: document.getElementById('invoice_payment_stage')?.options[document.getElementById('invoice_payment_stage')?.selectedIndex || 0]?.text || '',
                    amount: parseCurrency(document.getElementById('invoice_total_amount')?.value || '0'),
                    due: document.getElementById('invoice_due_date')?.value || ''
                }] : []);

            // Map stage values to human-friendly labels
            const stageLabels = {
                first: 'First Payment',
                second: 'Second Payment',
                third: 'Third Payment',
                service_fee: 'Service Fee'
            };

            // Render table rows
            const tbody = document.getElementById('preview_items_body');
            if (tbody) {
                tbody.innerHTML = items.map(it => {
                    const uniLabel = (it.universities && it.universities.length)
                        ? it.universities.slice(0, 4).join(', ')
                        : '-';
                    const stageText = stageLabels[it.stage] || it.stage || '-';
                    const desc = it.program === 'SERVICE'
                        ? `${stageText} - ${it.serviceName || 'Service'}`
                        : `${stageText} - ${programNames[it.program] || it.program || '-'}`;
                    const sub = it.program === 'SERVICE'
                        ? 'Service'
                        : `Application: ${it.appId} | ${uniLabel}`;
                    const amt = isNaN(it.amount) ? 0 : it.amount;
                    return `
                        <tr class="border-b border-gray-200">
                            <td class="py-3">
                                <p class="font-medium">${desc}</p>
                                <p class="text-xs text-gray-600">${sub}</p>
                            </td>
                            <td class="text-right font-semibold">$${amt.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        </tr>`;
                }).join('');
            }

            // Total and due date
            const total = items.reduce((s, it) => s + (isNaN(it.amount) ? 0 : Math.max(0, it.amount)), 0);
            document.getElementById('preview_total').textContent = `$${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const dueDates = items.map(it => it.due).filter(Boolean).map(d => new Date(d));
            const earliestDue = dueDates.length ? new Date(Math.min.apply(null, dueDates)) : null;
            const dueDateFormatted = earliestDue ? earliestDue.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '-';

            // Header info
            document.getElementById('preview_invoice_number').textContent = invoiceNumber;
            document.getElementById('preview_date').textContent = `Date: ${today}`;
            document.getElementById('preview_student_name').textContent = name || '-';
            document.getElementById('preview_student_email').textContent = email || '-';
            document.getElementById('preview_due_date').textContent = `Due: ${dueDateFormatted}`;
            const methodEl = document.getElementById('preview_payment_method');
            if (methodEl) methodEl.textContent = methodText;
        }

        function createInvoice() {
            const sendEmail = document.getElementById('send_email_notification').checked;

            // Here you would send data to backend
            const invoicePayload = {
                ...invoiceData,
                invoiceNumber: document.getElementById('preview_invoice_number').textContent,
                createdDate: new Date().toISOString(),
                sendEmail: sendEmail
            };

            console.log('Creating invoice:', invoicePayload);

            // Show success message
            alert(`✅ Invoice created successfully!\n\nInvoice Number: ${invoicePayload.invoiceNumber}\n${sendEmail ? 'Email notification sent to student.' : ''}`);

            closeCreateInvoiceModal();

            // Refresh the payments table (you would implement this)
            // loadPaymentsOverview();
        }

        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function () {
            lucide.createIcons();

            // Initialize Select2
            $('.select2').select2({
                width: '100%'
            });

            // Profile Dropdown Toggle
            const profileMenu = document.getElementById('profile-menu');
            const profileDropdown = document.getElementById('profile-dropdown');

            if (profileMenu && profileDropdown) {
                profileMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!profileMenu.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }
        });

        // Handle logout
        function handleLogout() {
            window.location.href = '../../login.html';
        }

        // AI Assistant functionality
        const aiToggle = document.getElementById('ai-toggle');
        const aiChatPanel = document.getElementById('ai-chat-panel');
        const aiClose = document.getElementById('ai-close');
        const chatInput = document.getElementById('chat-input');
        const sendMessage = document.getElementById('send-message');
        const chatMessages = document.getElementById('chat-messages');

        aiToggle.addEventListener('click', () => {
            aiChatPanel.classList.toggle('hidden');
        });

        aiClose.addEventListener('click', () => {
            aiChatPanel.classList.add('hidden');
        });

        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-4';

            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="flex items-start justify-end">
                        <div class="rounded-lg p-3 max-w-xs text-white" style="background-color: #d82128;">
                            <p class="text-sm">${message}</p>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center mr-2 mt-1">
                            <i data-lucide="bot" class="w-3 h-3" style="color: #d82128;"></i>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                            <p class="text-sm text-gray-800">${message}</p>
                        </div>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
        }

        function handleSendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                addMessage(message, true);
                chatInput.value = '';

                // Simulate AI response
                setTimeout(() => {
                    const responses = [
                        "You have $28,900 in approved but unpaid commissions. I recommend processing these within 2 business days to maintain agent satisfaction.",
                        "John Smith's commission of $2,500 is ready for approval. The linked application APP-2025-001 has been successfully enrolled.",
                        "Cash flow analysis shows 15% increase in scholarship disbursements this month. Consider adjusting budget allocation for Q2.",
                        "Fraud alert: Payment request from new agent requires additional verification. I've flagged it for manual review."
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addMessage(randomResponse);
                }, 1000);
            }
        }

        sendMessage.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        // Payment Details Modal Functions
        function openPaymentDetails() {
            document.getElementById('payment-details-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePaymentDetails() {
            document.getElementById('payment-details-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Evidence Viewer Modal Functions
        function openEvidenceViewer(url, fileName = '') {
            const modal = document.getElementById('evidence-viewer-modal');
            const img = document.getElementById('evidence-image');
            const pdf = document.getElementById('evidence-pdf');
            const download = document.getElementById('evidence-download');
            const openNew = document.getElementById('evidence-open-new');
            const nameEl = document.getElementById('evidence-file-name');

            // Basic type detection
            const isPdf = /\.pdf(\?|$)/i.test(url) || url.toLowerCase().includes('pdf');

            // Toggle views
            if (isPdf) {
                img.classList.add('hidden');
                img.src = '';
                pdf.classList.remove('hidden');
                pdf.src = url;
            } else {
                pdf.classList.add('hidden');
                pdf.src = '';
                img.classList.remove('hidden');
                img.src = url;
            }

            // Links and filename
            download.href = url;
            openNew.href = url;
            nameEl.textContent = fileName || url.split('/').pop().split('?')[0];

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (window.lucide && lucide.createIcons) lucide.createIcons();
        }

        function closeEvidenceViewer() {
            const modal = document.getElementById('evidence-viewer-modal');
            const img = document.getElementById('evidence-image');
            const pdf = document.getElementById('evidence-pdf');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            // Cleanup sources
            img.src = '';
            pdf.src = '';
        }

        // Payments table: mark as paid
        function markAsPaid(btn) {
            try {
                const row = btn.closest('tr');
                const badge = row.querySelector('.status-badge');
                if (!badge) return;

                // Update badge to Paid (green)
                badge.textContent = 'Paid';
                badge.classList.remove('bg-yellow-100', 'text-yellow-800');
                badge.classList.add('bg-green-100', 'text-green-800');

                // Disable the button and update style/text
                btn.disabled = true;
                btn.classList.remove('border-red-600', 'text-red-700', 'hover:bg-red-50');
                btn.classList.add('border-gray-200', 'text-gray-400', 'cursor-not-allowed');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i> Paid';

                if (window.lucide && lucide.createIcons) lucide.createIcons();

                // Re-apply current filter if not showing all
                const statusFilter = document.getElementById('status-filter');
                if (statusFilter) {
                    filterPayments(statusFilter.value);
                }
            } catch (e) {
                console.warn('Failed to mark as paid:', e);
            }
        }

        // Payments table: filter by status
        function filterPayments(filterValue) {
            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const badge = row.querySelector('.status-badge');
                if (!badge) return; // skip if no status
                const isPaid = /paid/i.test(badge.textContent.trim());
                let show = true;
                if (filterValue === 'paid') show = isPaid;
                else if (filterValue === 'unpaid') show = !isPaid;
                row.style.display = show ? '' : 'none';
            });
        }

        // Wire up status filter change
        document.addEventListener('DOMContentLoaded', function () {
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => filterPayments(e.target.value));
            }
        });

        // Payments Overview tab-only pagination (demo wiring)
        let overviewCurrentPage = 1;
        let overviewTotalPages = 5; // demo: replace with real total pages

        function renderOverviewPages() {
            const wrap = document.getElementById('overview_pages');
            if (!wrap) return;
            wrap.innerHTML = '';
            for (let p = 1; p <= overviewTotalPages; p++) {
                const b = document.createElement('button');
                b.type = 'button';
                b.textContent = p;
                b.dataset.page = String(p);
                b.className = 'min-w-8 inline-flex items-center justify-center px-2.5 py-1.5 text-sm border rounded-md hover:bg-gray-50 ' +
                    (p === overviewCurrentPage ? 'bg-red-600 text-white border-red-600' : 'text-gray-700');
                b.addEventListener('click', () => {
                    overviewCurrentPage = p;
                    updateOverviewPaginationUI();
                    // TODO: Load table data for the selected page
                });
                wrap.appendChild(b);
            }
        }

        function updateOverviewPaginationUI() {
            const info = document.getElementById('overview_page_info');
            const prev = document.getElementById('overview_prev');
            const next = document.getElementById('overview_next');
            if (info) info.textContent = `Page ${overviewCurrentPage} of ${overviewTotalPages}`;
            if (prev) prev.disabled = overviewCurrentPage <= 1;
            if (next) next.disabled = overviewCurrentPage >= overviewTotalPages;
            renderOverviewPages();
            if (window.lucide && lucide.createIcons) lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', function () {
            const prev = document.getElementById('overview_prev');
            const next = document.getElementById('overview_next');
            const rpp = document.getElementById('overview_rows_per_page');
            if (prev) prev.addEventListener('click', () => { if (overviewCurrentPage > 1) { overviewCurrentPage--; updateOverviewPaginationUI(); } });
            if (next) next.addEventListener('click', () => { if (overviewCurrentPage < overviewTotalPages) { overviewCurrentPage++; updateOverviewPaginationUI(); } });
            if (rpp) rpp.addEventListener('change', (e) => {
                const val = parseInt(e.target.value, 10) || 10;
                // demo rule: fewer pages with larger page size; replace with real computation
                overviewTotalPages = val === 10 ? 5 : val === 20 ? 3 : 2;
                overviewCurrentPage = 1;
                updateOverviewPaginationUI();
            });
            updateOverviewPaginationUI();
        });

        // Tab Switching for Payment Tabs
        function switchPaymentTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.payment-tab-content').forEach(tab => tab.classList.add('hidden'));
            // Remove active state from all tab buttons
            document.querySelectorAll('.payment-tab-button').forEach(btn => {
                btn.classList.remove('text-red-600');
                btn.classList.add('border-transparent', 'text-gray-500');
                btn.style.borderColor = '';
                btn.style.color = '';
            });
            // Show selected tab content
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            // Add active state to clicked button
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.style.borderColor = '#d82128';
            activeBtn.style.color = '#d82128';

            lucide.createIcons();
        }

        // Payment Config Management
        function getPaymentConfigKey(programType) {
            return `applylead_payment_config_${programType}`;
        }

        function getPaymentConfig(programType) {
            try {
                return JSON.parse(localStorage.getItem(getPaymentConfigKey(programType))) || {};
            } catch {
                return {};
            }
        }

        function setPaymentConfig(programType, config) {
            localStorage.setItem(getPaymentConfigKey(programType), JSON.stringify(config));
        }

        // Toggle functions for payment type selection
        function toggleFirstPaymentType(type) {
            const amountInput = document.getElementById('first_amount');
            const percentageInput = document.getElementById('first_percentage');

            if (type === 'amount') {
                amountInput.disabled = false;
                percentageInput.disabled = true;
                percentageInput.value = '';
            } else {
                amountInput.disabled = true;
                amountInput.value = '';
                percentageInput.disabled = false;
            }
        }

        function toggleSecondPaymentType(type) {
            const amountInput = document.getElementById('second_amount');
            const percentageInput = document.getElementById('second_percentage');

            if (type === 'amount') {
                amountInput.disabled = false;
                percentageInput.disabled = true;
                percentageInput.value = '';
            } else {
                amountInput.disabled = true;
                amountInput.value = '';
                percentageInput.disabled = false;
            }
        }

        function toggleThirdPaymentType(type) {
            const amountInput = document.getElementById('third_amount');
            const percentageInput = document.getElementById('third_percentage');

            if (type === 'amount') {
                amountInput.disabled = false;
                percentageInput.disabled = true;
                percentageInput.value = '';
            } else {
                amountInput.disabled = true;
                amountInput.value = '';
                percentageInput.disabled = false;
            }
        }

        function loadPaymentConfig() {
            const programType = document.getElementById('program_type').value;
            if (!programType) {
                document.getElementById('payment_stages_config').classList.add('hidden');
                return;
            }

            // Show payment stages config
            document.getElementById('payment_stages_config').classList.remove('hidden');

            // Load saved config
            const config = getPaymentConfig(programType);

            // First Payment
            if (config.first?.type === 'amount') {
                document.querySelector('input[name="first_type"][value="amount"]').checked = true;
                toggleFirstPaymentType('amount');
                document.getElementById('first_amount').value = config.first.value || '';
            } else if (config.first?.type === 'percentage') {
                document.querySelector('input[name="first_type"][value="percentage"]').checked = true;
                toggleFirstPaymentType('percentage');
                document.getElementById('first_percentage').value = config.first.value || '';
            }
            document.getElementById('first_step').value = config.first?.step || '';

            // Second Payment
            if (config.second?.type === 'amount') {
                document.querySelector('input[name="second_type"][value="amount"]').checked = true;
                toggleSecondPaymentType('amount');
                document.getElementById('second_amount').value = config.second.value || '';
            } else if (config.second?.type === 'percentage') {
                document.querySelector('input[name="second_type"][value="percentage"]').checked = true;
                toggleSecondPaymentType('percentage');
                document.getElementById('second_percentage').value = config.second.value || '';
            }
            document.getElementById('second_step').value = config.second?.step || '';

            // Third Payment
            if (config.third?.type === 'amount') {
                document.querySelector('input[name="third_type"][value="amount"]').checked = true;
                toggleThirdPaymentType('amount');
                document.getElementById('third_amount').value = config.third.value || '';
            } else if (config.third?.type === 'percentage') {
                document.querySelector('input[name="third_type"][value="percentage"]').checked = true;
                toggleThirdPaymentType('percentage');
                document.getElementById('third_percentage').value = config.third.value || '';
            }
            document.getElementById('third_step').value = config.third?.step || '';

            lucide.createIcons();
        }

        function savePaymentConfig() {
            const programType = document.getElementById('program_type').value;
            if (!programType) {
                alert('Please select a program type first.');
                return;
            }

            // Build config based on selected radio buttons
            const config = {};

            // First Payment
            const firstType = document.querySelector('input[name="first_type"]:checked')?.value;
            if (firstType) {
                config.first = {
                    type: firstType,
                    value: firstType === 'amount' ? document.getElementById('first_amount').value : document.getElementById('first_percentage').value,
                    step: document.getElementById('first_step').value
                };
            }

            // Second Payment
            const secondType = document.querySelector('input[name="second_type"]:checked')?.value;
            if (secondType) {
                config.second = {
                    type: secondType,
                    value: secondType === 'amount' ? document.getElementById('second_amount').value : document.getElementById('second_percentage').value,
                    step: document.getElementById('second_step').value
                };
            }

            // Third Payment
            const thirdType = document.querySelector('input[name="third_type"]:checked')?.value;
            if (thirdType) {
                config.third = {
                    type: thirdType,
                    value: thirdType === 'amount' ? document.getElementById('third_amount').value : document.getElementById('third_percentage').value,
                    step: document.getElementById('third_step').value
                };
            }

            setPaymentConfig(programType, config);
            alert(`Payment configuration for ${programType} saved successfully!`);
        }

        function resetPaymentConfig() {
            if (confirm('Are you sure you want to reset all fields? This will clear the current values.')) {
                // Reset First Payment
                document.querySelectorAll('input[name="first_type"]').forEach(r => r.checked = false);
                document.getElementById('first_amount').value = '';
                document.getElementById('first_amount').disabled = true;
                document.getElementById('first_percentage').value = '';
                document.getElementById('first_percentage').disabled = true;
                document.getElementById('first_step').value = '';

                // Reset Second Payment
                document.querySelectorAll('input[name="second_type"]').forEach(r => r.checked = false);
                document.getElementById('second_amount').value = '';
                document.getElementById('second_amount').disabled = true;
                document.getElementById('second_percentage').value = '';
                document.getElementById('second_percentage').disabled = true;
                document.getElementById('second_step').value = '';

                // Reset Third Payment
                document.querySelectorAll('input[name="third_type"]').forEach(r => r.checked = false);
                document.getElementById('third_amount').value = '';
                document.getElementById('third_amount').disabled = true;
                document.getElementById('third_percentage').value = '';
                document.getElementById('third_percentage').disabled = true;
                document.getElementById('third_step').value = '';
            }
        }
    </script>
</body>

</html>