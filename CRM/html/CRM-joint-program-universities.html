<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Joint Program Universities - APPLYLEAD CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>

<body class="bg-gray-50">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-screen w-64 bg-white shadow-lg overflow-y-auto overflow-x-hidden flex flex-col">
      <div class="p-6">
        <div class="flex items-center mb-2">
          <img src="../../ApplyLead_logo.png" alt="ApplyLead" class="h-9">
        </div>
        <div class="flex items-center">
          <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Admin</span>
        </div>
      </div>
      <nav class="mt">
        <a href="CRM-dashboard.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
          Dashboard
        </a>
        <a href="CRM-applications.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
          Applications
        </a>
        <a href="CRM-agent.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="users" class="w-5 h-5 mr-3"></i>
          Agents
        </a>
        <a href="CRM-scholarships.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="graduation-cap" class="w-5 h-5 mr-3"></i>
          Scholarships
        </a>
        <a href="CRM-institutions.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="building" class="w-5 h-5 mr-3"></i>
          Institutions
        </a>
        <a href="CRM-students.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="user" class="w-5 h-5 mr-3"></i>
          Students
        </a>
        <a href="CRM-payment.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="credit-card" class="w-5 h-5 mr-3"></i>
          Payments
        </a>
        <a href="CRM-tasks.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="check-circle" class="w-5 h-5 mr-3"></i>
          Tasks
        </a>
        <a href="CRM-Campaigns.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="brick-wall-shield" class="w-5 h-5 mr-3"></i>
          Campaigns
        </a>
        <a href="CRM-report.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="bar-chart" class="w-5 h-5 mr-3"></i>
          Reports
        </a>
        <a href="CRM-messages.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
          Messages
        </a>
        <a href="CRM-user-admin.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="shield" class="w-5 h-5 mr-3"></i>
          User Admin
        </a>
        <a href="CRM-joint-program-config.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>Ellacy Program
        </a>
        <a href="CRM-joint-program-universities.html" class="flex items-center px-6 py-3 text-white"
          style="background-color: #d82128;">
          <i data-lucide="building-2" class="w-5 h-5 mr-3"></i>
          Joint Program Universities
        </a>
        <a href="CRM-Setting.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">
          <i data-lucide="settings" class="w-5 h-5 mr-3"></i>
          Settings
        </a>
      </nav>
      <div class="mt-auto px-6 py-4 border-t border-gray-200">
        <p class="text-sm text-gray-600 text-center">Designed & developed by Innotech Viet Nam</p>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="ml-64 flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6">
        <div class="flex items-center gap-3">
          <img src="../../ApplyLead_logo.png" alt="ApplyLead" class="h-8" />
          <h1 class="text-lg font-semibold text-gray-800">Joint Program Universities</h1>
        </div>
        <div class="text-sm text-gray-500">CRM â€¢ Manage Vietnamese Partner Universities</div>
      </header>

      <!-- Main -->
      <main class="flex-1 overflow-y-auto p-6 w-full max-w-none">
        <!-- Actions -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <!-- Left: Search + Filters -->
          <div class="flex gap-2 order-2 sm:order-1">
            <input id="search" type="text" placeholder="Search by name..."
              class="px-3 py-2 border rounded-lg text-sm w-64" />
            <button id="btnFilters" class="px-4 py-2 rounded-lg border">Filters</button>
          </div>
          <!-- Right: Add + Export/Import -->
          <div class="flex gap-2 order-1 sm:order-2 sm:ml-auto">
            <button id="btnAdd" class="px-4 py-2 rounded-lg text-white" style="background-color:#d82128">+ Add
              University</button>
          </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl shadow-sm border overflow-visible min-h-[720px]">
          <div class="overflow-x-auto pb-24">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 text-gray-600">
                <tr>
                  <th class="text-left px-4 py-3">University Name</th>
                  <th class="text-left px-4 py-3">Abbreviation</th>
                  <th class="text-left px-4 py-3">Email</th>
                  <th class="text-left px-4 py-3">Phone Number</th>
                  <th class="text-left px-4 py-3">Status</th>
                  <th class="text-left px-4 py-3">Created</th>
                  <th class="text-right px-4 py-3">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody" class="divide-y">
                <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Empty state -->
        <div id="empty" class="hidden text-center py-16 text-gray-500">
          <i data-lucide="university" class="w-10 h-10 mx-auto mb-2"></i>
          <p>No universities yet. Click "Add University" to create one.</p>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 id="modalTitle" class="text-lg font-semibold">Add University</h3>
        <button id="btnClose" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <form id="form" class="p-5 space-y-4">
        <input type="hidden" id="id" />
        <div>
          <label class="block text-sm font-medium mb-1">Name <span class="text-red-600">*</span></label>
          <input id="name" type="text" class="w-full px-3 py-2 border rounded-lg" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Abbreviation</label>
          <input id="abbrev" type="text" placeholder="e.g., IUH, FTU, HUNRE, VLU"
            class="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">City</label>
            <input id="city" type="text" class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Status</label>
            <select id="status" class="w-full px-3 py-2 border rounded-lg">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Logo URL</label>
          <input id="logo" type="url" placeholder="https://..." class="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="email" type="email" placeholder="contact@university.edu.vn"
              class="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Phone Number</label>
            <input id="phone" type="tel" placeholder="e.g., +84 912 345 678"
              class="w-full px-3 py-2 border rounded-lg" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Programs <span class="text-red-600">*</span></label>
          <div class="flex gap-3 flex-wrap">
            <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="prog_13" /> 1+3</label>
            <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="prog_22" /> 2+2</label>
            <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="prog_mba" /> Joint
              MBA</label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Description</label>
          <textarea id="desc" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
        </div>

        <div id="password_group" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">Password <span class="text-red-600">*</span></label>
            <input id="password" type="password" class="w-full px-3 py-2 border rounded-lg" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Confirm Password <span class="text-red-600">*</span></label>
            <input id="confirm_password" type="password" class="w-full px-3 py-2 border rounded-lg" required />
          </div>
        </div>

        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" id="btnCancel" class="px-4 py-2 rounded-lg border">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg text-white" style="background-color:#d82128">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const LS_KEY = 'applylead_joint_universities';
    const tbody = document.getElementById('tbody');
    const empty = document.getElementById('empty');
    const search = document.getElementById('search');
    const filterStatus = document.getElementById('filterStatus');

    const modal = document.getElementById('modal');
    const form = document.getElementById('form');
    const modalTitle = document.getElementById('modalTitle');
    const btnAdd = document.getElementById('btnAdd');
    const btnClose = document.getElementById('btnClose');
    const btnCancel = document.getElementById('btnCancel');
    const btnExport = document.getElementById('btnExport');
    const importFile = document.getElementById('importFile');

    function uid() { return crypto.randomUUID ? crypto.randomUUID() : 'id-' + Date.now() + Math.random().toString(16).slice(2); }

    function getData() { try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; } catch { return []; } }
    function setData(arr) { localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

    // One-time migration to backfill email/phone for existing items
    const MIGR_KEY = 'applylead_joint_universities_migrated_v2';
    function mockEmailPhone(u) {
      const base = ((u.abbrev || u.name || 'university') + '').toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '').slice(0, 16) || 'university';
      const email = `${base}@university.edu.vn`;
      // Deterministic pseudo-phone from id/hash
      const s = (u.id || base);
      let h = 0; for (let i = 0; i < s.length; i++) { h = (h * 33 + s.charCodeAt(i)) >>> 0; }
      const digits = ('' + (h % 100000000)).padStart(8, '0');
      const phone = `+84 9${digits.slice(0, 1)} ${digits.slice(1, 4)} ${digits.slice(4)}`;
      return { email, phone };
    }
    function migrateEmailPhoneOnce() {
      if (localStorage.getItem(MIGR_KEY)) return;
      const data = getData();
      let changed = false;
      for (const u of data) {
        if (!u.email || !u.phone) {
          const m = mockEmailPhone(u);
          if (!u.email) u.email = m.email;
          if (!u.phone) u.phone = m.phone;
          changed = true;
        }
      }
      if (changed) setData(data);
      localStorage.setItem(MIGR_KEY, '1');
    }

    // Default universities (always shown even without localStorage)
    const DEFAULT_UNIS = [
      { id: 'def-iuh', name: 'Industrial University of Ho Chi Minh City', abbrev: 'IUH', email: 'intl@iuh.edu.vn', phone: '+84 28 38940390', status: 'active', programs: ['1+3', '2+2'], logo: 'https://logo.clearbit.com/iuh.edu.vn', updatedAt: Date.now() },
      { id: 'def-ftu', name: 'Foreign Trade University', abbrev: 'FTU', email: 'ico@ftu.edu.vn', phone: '+84 24 3259 5158', status: 'active', programs: ['1+3'], logo: 'https://logo.clearbit.com/ftu.edu.vn', updatedAt: Date.now() },
      { id: 'def-vlu', name: 'Van Lang University', abbrev: 'VLU', email: 'international@vlu.edu.vn', phone: '+84 28 7105 9999', status: 'active', programs: ['1+3', '2+2'], logo: 'https://logo.clearbit.com/vlu.edu.vn', updatedAt: Date.now() },
    ];

    function getAllData() {
      const map = new Map();
      const keyOf = (u) => ((u.abbrev || u.name || '').toLowerCase());
      for (const u of DEFAULT_UNIS) {
        const k = keyOf(u); if (!k) continue; map.set(k, u);
      }
      for (const u of getData()) {
        const k = keyOf(u); if (!k) continue; map.set(k, u); // local overrides defaults
      }
      return Array.from(map.values());
    }

    function render() {
      const q = (search.value || '').toLowerCase();
      const st = filterStatus ? filterStatus.value : '';
      const data = getAllData().filter(u => (
        !q || (u.name || '').toLowerCase().includes(q) || (u.abbrev || '').toLowerCase().includes(q)
      ) && (!st || u.status === st));
      tbody.innerHTML = '';
      if (data.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
      }
      data.forEach(u => tbody.appendChild(row(u)));
      lucide.createIcons();
    }

    function row(u) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-3">
          <div class="font-medium">${u.name || ''}</div>
          <div class="text-xs text-gray-500">${(u.desc || '').slice(0, 80)}</div>
        </td>
        <td class="px-4 py-3">${u.abbrev || ''}</td>
        <td class="px-4 py-3">${u.email || ''}</td>
        <td class="px-4 py-3">${u.phone || ''}</td>
        <td class="px-4 py-3">
          <span class="px-2 py-0.5 rounded-full text-xs ${u.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">${u.status || 'inactive'}</span>
        </td>
        <td class="px-4 py-3">${u.updatedAt ? new Date(u.updatedAt).toLocaleString() : '-'}</td>
        <td class="px-4 py-3 text-right whitespace-nowrap relative">
          <button class="inline-flex items-center px-2 py-1 border rounded-lg" onclick='toggleMenu("${u.id}")'>
            <i data-lucide="more-vertical" class="w-4 h-4"></i>
          </button>
          <div id="menu_${u.id}" class="hidden absolute right-0 mt-2 w-40 bg-white border rounded-lg shadow-lg z-10 text-left">
            <button class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2" onclick='onEdit("${u.id}")'>
              <i data-lucide="pencil" class="w-4 h-4"></i><span>Edit</span>
            </button>
            <button class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2" onclick='onConfig("${u.id}")'>
              <i data-lucide="settings" class="w-4 h-4"></i><span>Config</span>
            </button>
            <button class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2" onclick='onInactivate("${u.id}")'>
              <i data-lucide="slash" class="w-4 h-4"></i><span>Inactivate</span>
            </button>
            <button class="w-full px-3 py-2 text-left hover:bg-gray-50 text-red-600 flex items-center gap-2" onclick='onDelete("${u.id}")'>
              <i data-lucide="trash" class="w-4 h-4"></i><span>Delete</span>
            </button>
          </div>
        </td>`;
      return tr;
    }

    function onInactivate(id) {
      const data = getData();
      const idx = data.findIndex(u => u.id === id);
      if (idx === -1) return;
      data[idx] = { ...data[idx], status: 'inactive', updatedAt: Date.now() };
      setData(data);
      migrateEmailPhoneOnce();
      render();
    }

    function toggleMenu(id) {
      hideAllMenus();
      const el = document.getElementById(`menu_${id}`);
      if (el) el.classList.toggle('hidden');
    }

    function hideAllMenus() {
      document.querySelectorAll('[id^="menu_"]').forEach(el => el.classList.add('hidden'));
    }

    function openModal(editing = null) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      form.reset();
      document.getElementById('id').value = editing?.id || '';
      document.getElementById('name').value = editing?.name || '';
      document.getElementById('city').value = editing?.city || '';
      document.getElementById('abbrev').value = editing?.abbrev || '';
      document.getElementById('status').value = editing?.status || 'active';
      document.getElementById('logo').value = editing?.logo || '';
      document.getElementById('email').value = editing?.email || '';
      document.getElementById('phone').value = editing?.phone || '';
      document.getElementById('desc').value = editing?.desc || '';
      document.getElementById('prog_13').checked = (editing?.programs || []).includes('1+3');
      document.getElementById('prog_22').checked = (editing?.programs || []).includes('2+2');
      document.getElementById('prog_mba').checked = (editing?.programs || []).includes('Joint MBA');
      // Password fields: show only when adding new
      const pwGroup = document.getElementById('password_group');
      const pw = document.getElementById('password');
      const pwc = document.getElementById('confirm_password');
      const isEditing = !!editing;
      if (isEditing) {
        pwGroup.classList.add('hidden');
        pw.removeAttribute('required');
        pwc.removeAttribute('required');
        pw.value = '';
        pwc.value = '';
      } else {
        pwGroup.classList.remove('hidden');
        pw.setAttribute('required', 'true');
        pwc.setAttribute('required', 'true');
        pw.value = '';
        pwc.value = '';
      }
      modalTitle.textContent = editing ? 'Edit University' : 'Add University';
      lucide.createIcons();
    }

    function closeModal() { modal.classList.add('hidden'); document.body.style.overflow = ''; }

    function onEdit(id) { const u = getData().find(x => x.id === id); openModal(u); }
    function onConfig(id) { window.location.href = `CRM-joint-program-universities-details.html?id=${encodeURIComponent(id)}`; }
    function onDelete(id) { if (confirm('Delete this university?')) { setData(getData().filter(x => x.id !== id)); render(); } }

    btnAdd.addEventListener('click', () => openModal());
    btnClose.addEventListener('click', closeModal);
    btnCancel.addEventListener('click', closeModal);

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const isNew = !document.getElementById('id').value;
      // Required validations: Name, Programs, Password, Confirm Password
      const nameVal = document.getElementById('name').value.trim();
      const programsSel = [
        document.getElementById('prog_13').checked ? '1+3' : null,
        document.getElementById('prog_22').checked ? '2+2' : null,
        document.getElementById('prog_mba').checked ? 'Joint MBA' : null,
      ].filter(Boolean);
      const passwordVal = document.getElementById('password').value;
      const confirmVal = document.getElementById('confirm_password').value;
      if (!nameVal) { alert('Name is required'); return; }
      if (programsSel.length === 0) { alert('Please select at least one Program'); return; }
      if (isNew) {
        if (!passwordVal || !confirmVal) { alert('Password and Confirm Password are required'); return; }
        if (passwordVal !== confirmVal) { alert('Passwords do not match'); return; }
      }
      const id = document.getElementById('id').value || uid();
      const uni = {
        id,
        name: nameVal,
        city: document.getElementById('city').value.trim(),
        abbrev: document.getElementById('abbrev').value.trim(),
        status: document.getElementById('status').value,
        logo: document.getElementById('logo').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        desc: document.getElementById('desc').value.trim(),
        programs: programsSel,
        ...(isNew ? { password: passwordVal } : {}),
        updatedAt: Date.now(),
      };
      const data = getData();
      const idx = data.findIndex(x => x.id === id);
      if (idx >= 0) data[idx] = uni; else data.unshift(uni);
      setData(data);
      closeModal();
      render();
    });

    if (search) search.addEventListener('input', render);
    if (filterStatus) filterStatus.addEventListener('change', render);
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target.closest && target.closest('[id^="menu_"]')) && !(target.closest && target.closest('button[onclick^="toggleMenu"]'))) {
        hideAllMenus();
      }
    });

    if (btnExport) btnExport.addEventListener('click', () => {
      // Export without logo field
      const cleaned = getData().map(({ logo, ...rest }) => rest);
      const blob = new Blob([JSON.stringify(cleaned, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'joint_program_universities.json';
      a.click();
    });

    if (importFile) importFile.addEventListener('change', (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const arr = JSON.parse(reader.result);
          if (Array.isArray(arr)) {
            // Clean any 'logo' field on import
            const cleaned = arr.map(u => {
              const { logo, ...rest } = u || {};
              return rest;
            });
            setData(cleaned);
            render();
          }
        } catch { alert('Invalid JSON'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    render();
    lucide.createIcons();
  </script>

  <!-- Filters Drawer -->
  <div id="filtersOverlay" class="hidden fixed inset-0 bg-black/40 z-40"></div>
  <aside id="filtersDrawer"
    class="hidden fixed right-0 top-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 flex flex-col">
    <div class="flex items-center justify-between px-5 py-4 border-b">
      <h3 class="text-lg font-semibold">Filters</h3>
      <button id="filtersClose" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="x"
          class="w-5 h-5"></i></button>
    </div>
    <div class="p-5 space-y-5 flex-1 overflow-y-auto">
      <div>
        <div class="text-sm font-medium mb-2">Status</div>
        <select id="f_status" class="w-full px-3 py-2 border rounded-lg text-sm">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>
    <div class="p-5 border-t flex items-center justify-between gap-2">
      <button id="filtersClear" class="px-4 py-2 rounded-lg border">Clear</button>
      <div class="flex gap-2">
        <button id="filtersCancel" class="px-4 py-2 rounded-lg border">Cancel</button>
        <button id="filtersApply" class="px-4 py-2 rounded-lg text-white"
          style="background-color:#d82128">Apply</button>
      </div>
    </div>
  </aside>

  <script>
    // Drawer logic and filter wiring
    const filtersDrawer = document.getElementById('filtersDrawer');
    const filtersOverlay = document.getElementById('filtersOverlay');
    const filtersClose = document.getElementById('filtersClose');
    const filtersCancel = document.getElementById('filtersCancel');
    const filtersApply = document.getElementById('filtersApply');
    const filtersClear = document.getElementById('filtersClear');
    const f_status = document.getElementById('f_status');

    let filterStatusDrawer = '';

    function openFilters() {
      filtersDrawer.classList.remove('hidden');
      filtersOverlay.classList.remove('hidden');
    }
    function closeFilters() { filtersDrawer.classList.add('hidden'); filtersOverlay.classList.add('hidden'); }

    btnFilters.addEventListener('click', openFilters);
    filtersClose.addEventListener('click', closeFilters);
    filtersCancel.addEventListener('click', closeFilters);
    filtersOverlay.addEventListener('click', closeFilters);
    filtersClear.addEventListener('click', () => {
      f_status.value = '';
    });
    filtersApply.addEventListener('click', () => {
      filterStatusDrawer = f_status.value || '';
      closeFilters();
      render();
    });

    // extend render to include program/city filters
    const _render = render;
    render = function () {
      const q = (search.value || '').toLowerCase();
      const st = filterStatus ? filterStatus.value : '';
      const data = getAllData().filter(u => {
        const matchQuery = !q || (u.name || '').toLowerCase().includes(q) || (u.abbrev || '').toLowerCase().includes(q);
        const statusToUse = (filterStatusDrawer || st);
        const matchStatus = !statusToUse || u.status === statusToUse;
        return matchQuery && matchStatus;
      });
      tbody.innerHTML = '';
      if (data.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
      }
      data.forEach(u => tbody.appendChild(row(u)));
      lucide.createIcons();
    }

    render();
    lucide.createIcons();
  </script>
</body>

</html>